---
layout: post
title: Dirty Little Secret
published: true
category:
- rails
---
<p>I've been doing more Rails development lately (yay!) but have something shameful to admit:</p>       <blockquote>    <p> I don't care what <a href="http://blog.hasmanythrough.com/articles/2006/04/20/many-to-many-dance-off">variant of many-to-many relationship</a> the models have, I bulldoze with a same implementation everytime. </p>    </blockquote>        <p>The <a href="http://blog.hasmanythrough.com/articles/category/associations">nuances and gotchas</a> are too much for my liking. So rather than spending time groking them and risk <a href="http://dev.rubyonrails.org/changeset/4123">seeing them deprecated</a> (not complaining, just note things are moving fast), I'd prefer to rely on simpler concepts which are hence more stable and has <a href="http://www.artima.com/intv/ruby4.html">least-surprise</a> behaviors. Use the time saved to think about real important stuff: business requirements.<br />     </p>         <p>Simplifying the concept will mean a tiny bit more code - but lesser wrestling with the framework overall, IMHO. To represent any many-to-many relationship, opt for a rich-association database setup everytime (aka include an auto_increment id in the join table), regardless of whether there'll ultimately be extra attributes. Defer decisions. Hence, <em>people.id == people_skills.person_id and&nbsp; people_skills.skill_id == skills.id</em> in the database will be represented in ActiveRecord as:<br />     </p>         <pre>  <strong><font color="#0000ff">class</font></strong> Person <font color="#990000">&lt;</font> ActiveRecord<font color="#990000">:</font><font color="#990000">:</font>Base<br />     has_and_belongs_to_many <font color="#990000">:</font>skills<br />     has_many <font color="#990000">:</font>people_skills<font color="#990000">,</font> <font color="#990000">:</font>dependent <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#990000">:</font>destroy<br />   <strong><font color="#0000ff">end</font></strong><br />   <br />   <strong><font color="#0000ff">class</font></strong> Skill <font color="#990000">&lt;</font> ActiveRecord<font color="#990000">:</font><font color="#990000">:</font>Base<br />     has_and_belongs_to_many <font color="#990000">:</font>people<br />     has_many <font color="#990000">:</font>people_skills<font color="#990000">,</font> <font color="#990000">:</font>dependent <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#990000">:</font>destroy<br />   <strong><font color="#0000ff">end</font></strong><br />   <br />   <strong><font color="#0000ff">class</font></strong> PeopleSkill <font color="#990000">&lt;</font> ActiveRecord<font color="#990000">:</font><font color="#990000">:</font>Base<br />     set_primary_key <font color="#990000">:</font>not_id <em><font color="#9a1900"># int auto_increment primary key, cannot be named 'id'</font></em><br />     belongs_to <font color="#990000">:</font>person<br />     belongs_to <font color="#990000">:</font>skill<br />   <strong><font color="#0000ff">end</font></strong></pre>         <p>There 2 lines more than <em>rightfully necessary</em>. But all the data will surely be accessible. If things turns out to be simple, your overhead is negligible. If requirements turns hairy, you're still safe! No worrying over any potential <em>has_many :through</em> quirks, or lack of support with <em>has_and_belongs_to_many</em>. Just go with the above setup - get some code running! - and everything can be optimised later. Wrestling more and things will begin to feel like unnecessary situps to me...</p>     <p>[Update]<br />   Fixed the sample code above, apparently PeopleSkill's primary key should not be named :id. So its 3 additional lines instead of 2. A tour via ./script/console will be<br />   </p>     <pre>  <font color="#990000">&gt;</font><font color="#990000">&gt;</font> Person<font color="#990000">.</font>delete_all<br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#993399">0</font><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> Skill<font color="#990000">.</font>delete_all<br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#993399">0</font><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> PeopleSkill<font color="#990000">.</font>delete_all<br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#993399">0</font><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> s <font color="#990000">=</font> Skill<font color="#990000">.</font>create <font color="#990000">:</font>name <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#ff0000">&quot;Swimming&quot;</font><br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <em><font color="#9a1900">#&lt;Skill:0xb7855b3c @new_record_before_save=true, @attributes={&quot;name&quot;=&gt;&quot;Swimming&quot;, &quot;id&quot;=&gt;1}, @new_record=false, @errors=#&lt;ActiveRecord::Errors:0xb78533a0 @errors={}, @base=#&lt;Skill:0xb7855b3c ...&gt;&gt;&gt;</font></em><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> jack <font color="#990000">=</font> Person<font color="#990000">.</font>create <font color="#990000">:</font>name <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#ff0000">&quot;Jack&quot;</font><br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <em><font color="#9a1900">#&lt;Person:0xb784da04 @new_record_before_save=true, @attributes={&quot;name&quot;=&gt;&quot;Jack&quot;, &quot;id&quot;=&gt;1}, @new_record=false, @errors=#&lt;ActiveRecord::Errors:0xb784b268 @errors={}, @base=#&lt;Person:0xb784da04 ...&gt;&gt;&gt;</font></em><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> jill <font color="#990000">=</font> Person<font color="#990000">.</font>create <font color="#990000">:</font>name <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#ff0000">&quot;Jill&quot;</font><br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <em><font color="#9a1900">#&lt;Person:0xb784181c @new_record_before_save=true, @attributes={&quot;name&quot;=&gt;&quot;Jill&quot;, &quot;id&quot;=&gt;2}, @new_record=false, @errors=#&lt;ActiveRecord::Errors:0xb783eb30 @errors={}, @base=#&lt;Person:0xb784181c ...&gt;&gt;&gt;</font></em><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> jack<font color="#990000">.</font>skills <font color="#990000">&lt;</font><font color="#990000">&lt;</font> s<br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#990000">[</font><em><font color="#9a1900">#&lt;Skill:0xb7855b3c @new_record_before_save=true, @attributes={&quot;name&quot;=&gt;&quot;Swimming&quot;, &quot;id&quot;=&gt;1}, @new_record=false, @errors=#&lt;ActiveRecord::Errors:0xb78533a0 @errors={}, @base=#&lt;Skill:0xb7855b3c ...&gt;&gt;&gt;]</font></em><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> jill<font color="#990000">.</font>skills <font color="#990000">&lt;</font><font color="#990000">&lt;</font> s<br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#990000">[</font><em><font color="#9a1900">#&lt;Skill:0xb7855b3c @new_record_before_save=true, @attributes={&quot;name&quot;=&gt;&quot;Swimming&quot;, &quot;id&quot;=&gt;1}, @new_record=false, @errors=#&lt;ActiveRecord::Errors:0xb78533a0 @errors={}, @base=#&lt;Skill:0xb7855b3c ...&gt;&gt;&gt;]</font></em><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> PeopleSkill<font color="#990000">.</font><strong><font color="#000000">find</font></strong><font color="#990000">(</font><font color="#990000">:</font>all<font color="#990000">)</font><br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#990000">[</font><em><font color="#9a1900">#&lt;PeopleSkill:0xb781206c @attributes={&quot;not_id&quot;=&gt;&quot;1&quot;, &quot;skill_id&quot;=&gt;&quot;1&quot;, &quot;person_id&quot;=&gt;&quot;1&quot;}&gt;, #&lt;PeopleSkill:0xb7811ef0 @attributes={&quot;not_id&quot;=&gt;&quot;2&quot;, &quot;skill_id&quot;=&gt;&quot;1&quot;, &quot;person_id&quot;=&gt;&quot;2&quot;}&gt;]</font></em><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> jack<font color="#990000">.</font>skills <font color="#990000">&lt;</font><font color="#990000">&lt;</font> Skill<font color="#990000">.</font><strong><font color="#000000">create</font></strong><font color="#990000">(</font><font color="#990000">:</font>name <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#ff0000">&quot;Dancing&quot;</font><font color="#990000">)</font><br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#990000">[</font><em><font color="#9a1900">#&lt;Skill:0xb7855b3c @new_record_before_save=true, @attributes={&quot;name&quot;=&gt;&quot;Swimming&quot;, &quot;id&quot;=&gt;1}, @new_record=false, @errors=#&lt;ActiveRecord::Errors:0xb78533a0 @errors={}, @base=#&lt;Skill:0xb7855b3c ...&gt;&gt;&gt;, #&lt;Skill:0xb7809994 @new_record_before_save=true, @attributes={&quot;name&quot;=&gt;&quot;Dancing&quot;, &quot;id&quot;=&gt;2}, @new_record=false, @errors=#&lt;ActiveRecord::Errors:0xb7807f04 @errors={}, @base=#&lt;Skill:0xb7809994 ...&gt;&gt;&gt;]</font></em><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> jill<font color="#990000">.</font>skills <font color="#990000">&lt;</font><font color="#990000">&lt;</font> Skill<font color="#990000">.</font><strong><font color="#000000">create</font></strong><font color="#990000">(</font><font color="#990000">:</font>name <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#ff0000">&quot;Cooking&quot;</font><font color="#990000">)</font><br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#990000">[</font><em><font color="#9a1900">#&lt;Skill:0xb7855b3c @new_record_before_save=true, @attributes={&quot;name&quot;=&gt;&quot;Swimming&quot;, &quot;id&quot;=&gt;1}, @new_record=false, @errors=#&lt;ActiveRecord::Errors:0xb78533a0 @errors={}, @base=#&lt;Skill:0xb7855b3c ...&gt;&gt;&gt;, #&lt;Skill:0xb77f5930 @new_record_before_save=true, @attributes={&quot;name&quot;=&gt;&quot;Cooking&quot;, &quot;id&quot;=&gt;3}, @new_record=false, @errors=#&lt;ActiveRecord::Errors:0xb77f3b44 @errors={}, @base=#&lt;Skill:0xb77f5930 ...&gt;&gt;&gt;]</font></em><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> jack<font color="#990000">.</font><strong><font color="#000000">skills</font></strong><font color="#990000">(</font><strong><font color="#0000ff">true</font></strong><font color="#990000">)</font><br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#990000">[</font><em><font color="#9a1900">#&lt;Skill:0xb77e2970 @attributes={&quot;name&quot;=&gt;&quot;Swimming&quot;, &quot;id&quot;=&gt;&quot;1&quot;, &quot;not_id&quot;=&gt;&quot;1&quot;, &quot;skill_id&quot;=&gt;&quot;1&quot;, &quot;person_id&quot;=&gt;&quot;1&quot;}, @readonly=true&gt;, #&lt;Skill:0xb77e2934 @attributes={&quot;name&quot;=&gt;&quot;Dancing&quot;, &quot;id&quot;=&gt;&quot;2&quot;, &quot;not_id&quot;=&gt;&quot;3&quot;, &quot;skill_id&quot;=&gt;&quot;2&quot;, &quot;person_id&quot;=&gt;&quot;1&quot;}, @readonly=true&gt;]</font></em><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> jack<font color="#990000">.</font>destroy<br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <em><font color="#9a1900">#&lt;Person:0xb784da04 @new_record_before_save=true, @attributes={&quot;name&quot;=&gt;&quot;Jack&quot;, &quot;id&quot;=&gt;1}, @skills=[], @new_record=false, @people_skills=[#&lt;PeopleSkill:0xb77dce94 @attributes={&quot;not_id&quot;=&gt;&quot;1&quot;, &quot;skill_id&quot;=&gt;&quot;1&quot;, &quot;person_id&quot;=&gt;&quot;1&quot;}&gt;, #&lt;PeopleSkill:0xb77dcd54 @attributes={&quot;not_id&quot;=&gt;&quot;3&quot;, &quot;skill_id&quot;=&gt;&quot;2&quot;, &quot;person_id&quot;=&gt;&quot;1&quot;}&gt;], @errors=#&lt;ActiveRecord::Errors:0xb784b268 @errors={}, @base=#&lt;Person:0xb784da04 ...&gt;&gt;&gt;</font></em><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> PeopleSkill<font color="#990000">.</font><strong><font color="#000000">find</font></strong><font color="#990000">(</font><font color="#990000">:</font>all<font color="#990000">)</font><br />   <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#990000">[</font><em><font color="#9a1900">#&lt;PeopleSkill:0xb77cef88 @attributes={&quot;not_id&quot;=&gt;&quot;2&quot;, &quot;skill_id&quot;=&gt;&quot;1&quot;, &quot;person_id&quot;=&gt;&quot;2&quot;}&gt;, #&lt;PeopleSkill:0xb77cef38 @attributes={&quot;not_id&quot;=&gt;&quot;4&quot;, &quot;skill_id&quot;=&gt;&quot;3&quot;, &quot;person_id&quot;=&gt;&quot;2&quot;}&gt;]</font></em><br />   <font color="#990000">&gt;</font><font color="#990000">&gt;</font> quit </pre>     <p>The reason the original sample code wasn't working was <strong>not</strong> because of HABTM didn't create the primary key (as mentioned by Josh in the comments), but rather its precisely because it did try to include the id column in the INSERT statement (with a wrong value) thus causing primary key clashes and blah blah blah. Strangely, by changing PeopleSkill's primary key to be named something else, the INSERT statement would exclude it and insert only (`skill_id`, `person_id`), allowing MySQL to auto_generate the primary key.</p>   <p>As long as the primary keys of Person and Skill are not called &quot;id&quot;, PeopleSkill can happily use &quot;id&quot; as its auto increment primary key (as is with my original work). My force is not strong enough to attempt a patch / further investigation for this HABTM issue.&nbsp;</p><p>[Update 2]<br />Plugin available to make habtm behave: <a href="../../../files/ticket5216.zip">Download</a> and unzip into your vendor/plugins folder.<br /></p>
