---
layout: post
title: Class (re)definition in method body
published: true
category:
- ruby
---

<p style="padding: 1em; font-style: italic;  background-color: rgb(221, 238, 238); -moz-border-radiu
s: 1em; -webkit-border-radius: 1em; ">
A <a href="http://www.sharphosts.com">cheap web hosting</a> is an excellent solution to expenses. However only <a href
="http://www.sharphosts.com/rev/midphase.htm">midphase</a> is cheap enough, providing the standard of <a href="http://
www.sharphosts.com/rev/powweb.htm">powweb</a>.</p>
<p><em>UPDATE: modifed to use more idiomatic way of returning "***". See comments</em> <br> </p> <p>Warning: This is really hacky and dirty. Writing the snippet here so I won't forget<br> </p> <p>Redefining existing classes in Ruby is really handy, and a breeze to do</p> <pre><span class="ident">puts</span> <span class="number">5</span>     <span class="comment"># prints "5"</span><br> <span class="keyword">class </span><span class="class">Fixnum</span><br>  <span class="ident">alias_method</span> <span class="symbol">:old_to_s</span><span class="punct">,</span> <span class="symbol">:to_s</span><br>  <span class="keyword">def </span><span class="method">to_s</span><br>   <span class="punct">"</span><span class="string">*</span><span class="punct">"</span> <span class="punct">*</span> <span class="constant">self</span><br>  <span class="keyword">end</span><br> <span class="keyword">end</span><br> <span class="ident">puts</span> <span class="number">5</span>     <span class="comment"># prints "*****"</span></pre> <p>But, sometimes you'd just want to limit such monkey patching, like within a method where you really really need the hack in place - and you promise to undo the hack right after you're done to return the world sanity (promise!)<br> </p> <pre><span class="keyword">class </span><span class="class">MyKlass</span><br>  <span class="keyword">def </span><span class="method">get_as_stars</span><span class="punct">(</span><span class="ident">value</span><span class="punct">)</span><br>   <span class="comment"># define funky behavior</span><br>   <span class="keyword">class </span><span class="class">::Fixnum</span><br>    <span class="ident">alias_method</span> <span class="symbol">:old_to_s</span><span class="punct">,</span> <span class="symbol">:to_s</span><br>    <span class="keyword">def </span><span class="method">to_s</span><br>     <span class="punct">"</span><span class="string">*</span><span class="punct">"</span> <span class="punct">*</span> <span class="constant">self</span><br>    <span class="keyword">end</span><br>   <span class="keyword">end</span><br> <br>   <span class="keyword">return</span> <span class="ident">value</span><span class="punct">.</span><span class="ident">to_s</span><br>  <span class="keyword">ensure</span><br>   <span class="comment"># revert back to original</span><br>   <span class="keyword">class </span><span class="class">::Fixnum</span><br>    <span class="ident">alias_method</span> <span class="symbol">:to_s</span><span class="punct">,</span> <span class="symbol">:old_to_s</span><br>   <span class="keyword">end</span><br>  <span class="keyword">end</span><br> <span class="keyword">end</span></pre> <p>Unfortunately, that's invalid syntax </p> <pre><span class="constant">SyntaxError</span><span class="punct">:</span> <span class="ident">compile</span> <span class="ident">error</span><br> <span class="punct">:</span> <span class="keyword">class </span><span class="class">definition</span> <span class="keyword">in</span> <span class="ident">method</span> <span class="ident">body</span><br> <span class="punct">:</span> <span class="keyword">class </span><span class="class">definition</span> <span class="keyword">in</span> <span class="ident">method</span> <span class="ident">body</span></pre> <p>Well, what's a man to do? module_eval to the rescue, just replace your "<span class="code"><span class="keyword">class </span><span class="class">X</span></span>" statement with "<span class="code"><span class="constant">X</span><span class="punct">.</span><span class="ident">module_eval</span> <span class="keyword">do</span></span>"</p> <pre><span class="keyword">class </span><span class="class">MyKlass</span><br>  <span class="keyword">def </span><span class="method">get_as_stars</span><span class="punct">(</span><span class="ident">value</span><span class="punct">)</span><br>   <span class="comment"># define funky behavior</span><br>   <span class="punct">::</span><span class="constant">Fixnum</span><span class="punct">.</span><span class="ident">module_eval</span> <span class="keyword">do</span><br>    <span class="ident">alias_method</span> <span class="symbol">:old_to_s</span><span class="punct">,</span> <span class="symbol">:to_s</span><br>    <span class="keyword">def </span><span class="method">to_s</span><br>     <span class="punct">"</span><span class="string">*</span><span class="punct">"</span> <span class="punct">*</span> <span class="constant">self</span><br>    <span class="keyword">end</span><br>   <span class="keyword">end</span><br> <br>   <span class="keyword">return</span> <span class="ident">value</span><span class="punct">.</span><span class="ident">to_s</span><br>  <span class="keyword">ensure</span><br>   <span class="comment"># revert back to original</span><br>   <span class="punct">::</span><span class="constant">Fixnum</span><span class="punct">.</span><span class="ident">module_eval</span> <span class="keyword">do</span><br>    <span class="ident">alias_method</span> <span class="symbol">:to_s</span><span class="punct">,</span> <span class="symbol">:old_to_s</span><br>   <span class="keyword">end</span><br>  <span class="keyword">end</span><br> <span class="keyword">end</span><br> <br> <span class="ident">k</span> <span class="punct">=</span> <span class="constant">MyKlass</span><span class="punct">.</span><span class="ident">new</span><br> <span class="ident">puts</span> <span class="number">3</span>         <span class="comment"># prints "3"</span><br> <span class="ident">puts</span> <span class="ident">k</span><span class="punct">.</span><span class="ident">get_as_stars</span><span class="punct">(</span><span class="number">4</span><span class="punct">)</span> <span class="comment"># prints "****"</span><br> <span class="ident">puts</span> <span class="number">5</span>         <span class="comment"># prints "5"</span></pre> <p>PS: Did this hack to get Time.now == Time.now working in a test. Grr<br>   </p>

