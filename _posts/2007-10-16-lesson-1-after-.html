---
layout: post
title: 'Lesson #1 after using the iPhone: Automatic Orientation'
published: true
category:
- ruby
---

<p>Remember those days of downloading your photos from your camera, then going through them, one by one... and rotating each picture right-side up until you get drowsy or give up? Such tedious work! Oh, and did you click save after you rotated?</p>

<p>Apparently, pictures taken from the iPhone and many new digital cameras (though none from <a href="http://www.google.com/search?esrch=BetaShortcuts&amp;q=is%20the%20World's%20largest%20camera%20manufacturer">the world's largest camera manufacturer</a>) comes embedded with orientation information! To put it simply, it means that these digital photos already know if they are landscape or portrait - How cool is that?</p>

<p>Unfortunately, not all software makes use of this piece of information to save you the labor. And <a href="http://flickr.com/photos/choonkeat/tags/orientation/">this includes even cool sites like Flickr</a> :-( What a shame. And it doesn't help that most image upload/resize/crop HOWTOs doesn't talk about it either.</p>

<p><a href="http://sharedcopy.com/">SharedCopy</a> is cooler than that. Though imaging is not our forte, and its just done for your little profile picture, things are set up such that your profile picture will be right-side up :-D And now, with the help of some monkey-patching, your Rails/Ruby-powered website can be as cool too!</p>

<p><a href="http://rmagick.rubyforge.org/">RMagick</a> users, simply include the code below (e.g. append to config/environment.rb):</p>

<pre><span style="color: #000000;">require</span> <span style="color: #6a5acd;">'</span><span style="color: #dd00dd;">RMagick</span><span style="color: #6a5acd;">'</span> <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">unless</span></span> <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">defined?</span></span><span style="color: #6a5acd;">(</span><span style="color: #008b8b;">Magick</span><span style="color: #6a5acd;">)</span><br /><span style="color: #008b8b;">Magick</span><span style="color: #6a5acd;">::</span><span style="color: #008b8b;">Image</span><span style="color: #6a5acd;">.</span><span style="color: #000000;">class_eval</span> <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">do</span></span><br />&nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">class </span></span><span style="color: #6a5acd;">&lt;&lt;</span> <span style="color: #008b8b;">self</span><br />&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">def </span></span><span style="color: #008b8b;">read_with_auto_upright</span><span style="color: #6a5acd;">(*</span><span style="color: #000000;">args</span><span style="color: #6a5acd;">,</span> <span style="color: #6a5acd;">&amp;</span><span style="color: #000000;">block</span><span style="color: #6a5acd;">)</span><br />&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #008b8b;">self</span><span style="color: #6a5acd;">.</span><span style="color: #000000;">read_without_auto_upright</span><span style="color: #6a5acd;">(*</span><span style="color: #000000;">args</span><span style="color: #6a5acd;">,</span> <span style="color: #6a5acd;">&amp;</span><span style="color: #000000;">block</span><span style="color: #6a5acd;">).</span><span style="color: #000000;">collect</span> <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">do</span></span> <span style="color: #6a5acd;">|</span><span style="color: #000000;">img</span><span style="color: #6a5acd;">|</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">begin</span></span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #0000ff;"># if there's nothing to rotate, auto_orient! will return nil</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #000000;">img</span><span style="color: #6a5acd;">.</span><span style="color: #000000;">auto_orient!</span> <span style="color: #6a5acd;">||</span> <span style="color: #000000;">img</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">rescue</span></span> <span style="color: #008b8b;">NotImplementedError</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #0000ff;"># Older versions of ImageMagick has no auto_orient!</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">case</span></span> <span style="color: #000000;">img</span><span style="color: #6a5acd;">.</span><span style="color: #000000;">get_exif_by_entry</span><span style="color: #6a5acd;">(&quot;</span><span style="color: #dd00dd;">Orientation</span><span style="color: #6a5acd;">&quot;)</span> <span style="color: #6a5acd;">&amp;&amp;</span> <span style="color: #000000;">img</span><span style="color: #6a5acd;">[&quot;</span><span style="color: #dd00dd;">EXIF:Orientation</span><span style="color: #6a5acd;">&quot;]</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #0000ff;"># img[&quot;EXIF:Orientation&quot;] might not be ready until get_exif_by_entry() is called</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">when</span></span> <span style="color: #6a5acd;">&quot;</span><span style="color: #dd00dd;">6</span><span style="color: #6a5acd;">&quot;</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #0000ff;"># Magick::RightTopOrientation</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #000000;">img</span><span style="color: #6a5acd;">.</span><span style="color: #000000;">rotate!</span><span style="color: #6a5acd;">(</span><span style="color: #dd00dd;">90</span><span style="color: #6a5acd;">)</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #000000;">img</span><span style="color: #6a5acd;">[&quot;</span><span style="color: #dd00dd;">EXIF:Orientation</span><span style="color: #6a5acd;">&quot;]</span> <span style="color: #6a5acd;">=</span> <span style="color: #6a5acd;">&quot;</span><span style="color: #dd00dd;">1</span><span style="color: #6a5acd;">&quot;</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">when</span></span> <span style="color: #6a5acd;">&quot;</span><span style="color: #dd00dd;">3</span><span style="color: #6a5acd;">&quot;</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #0000ff;"># Magick::BottomRightOrientation</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #000000;">img</span><span style="color: #6a5acd;">.</span><span style="color: #000000;">rotate!</span><span style="color: #6a5acd;">(</span><span style="color: #dd00dd;">180</span><span style="color: #6a5acd;">)</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #000000;">img</span><span style="color: #6a5acd;">[&quot;</span><span style="color: #dd00dd;">EXIF:Orientation</span><span style="color: #6a5acd;">&quot;]</span> <span style="color: #6a5acd;">=</span> <span style="color: #6a5acd;">&quot;</span><span style="color: #dd00dd;">1</span><span style="color: #6a5acd;">&quot;</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">when</span></span> <span style="color: #6a5acd;">&quot;</span><span style="color: #dd00dd;">8</span><span style="color: #6a5acd;">&quot;</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #0000ff;"># Magick::LeftBottomOrientation</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #000000;">img</span><span style="color: #6a5acd;">.</span><span style="color: #000000;">rotate!</span><span style="color: #6a5acd;">(</span><span style="color: #dd00dd;">270</span><span style="color: #6a5acd;">)</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #000000;">img</span><span style="color: #6a5acd;">[&quot;</span><span style="color: #dd00dd;">EXIF:Orientation</span><span style="color: #6a5acd;">&quot;]</span> <span style="color: #6a5acd;">=</span> <span style="color: #6a5acd;">&quot;</span><span style="color: #dd00dd;">1</span><span style="color: #6a5acd;">&quot;</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">end</span></span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #000000;">img</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">end</span></span><br />&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">end</span></span><br />&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">end</span></span><br /><br />&nbsp; &nbsp; <span style="color: #0000ff;"># wrap around RMagick::Image#read method so that </span><br />&nbsp; &nbsp; <span style="color: #0000ff;"># any images loaded in memory are already upright</span><br />&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">alias</span></span> <span style="color: #008b8b;">:read_without_auto_upright</span> <span style="color: #008b8b;">:read</span><br />&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">alias</span></span> <span style="color: #008b8b;">:read</span> <span style="color: #008b8b;">:read_with_auto_upright</span><br />&nbsp; &nbsp; <span class="comment" style="color: rgb(0, 0, 255);"># note: not using alias_method_chain so that this</span><br />&nbsp; &nbsp; <span class="comment" style="color: rgb(0, 0, 255);">#&nbsp; &nbsp;&nbsp; &nbsp; snippet can be used outside of Rails<br /></span>&nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">end</span></span><br /><span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">end</span></span>
</pre>

<p><span style="color: #008b8b;">&nbsp;</span>


<a href="http://seattlerb.rubyforge.org/ImageScience.html">ImageScience</a> users, if you trust my C++ code, just place <a href="http://pastie.caboo.se/107610">this patched image_science.rb</a> in your vendor/ directory. Otherwise you can apply this patch manually:</p>

<pre><span style="color: #6a5acd;">---</span> <span style="color: #000000;">lib</span><span style="color: #6a5acd;">/</span><span style="color: #000000;">image_science</span><span style="color: #6a5acd;">.</span><span style="color: #000000;">rb</span>	<span style="color: #dd00dd;">2007</span><span style="color: #6a5acd;">-</span><span style="color: #dd00dd;">10</span><span style="color: #6a5acd;">-</span><span style="color: #dd00dd;">16</span> <span style="color: #dd00dd;">12</span><span style="color: #6a5acd;">:</span><span style="color: #dd00dd;">11</span><span style="color: #6a5acd;">:</span><span style="color: #dd00dd;">08.000000000</span> <span style="color: #6a5acd;">+</span><span style="color: #dd00dd;">0800</span><br /><span style="color: #6a5acd;">+++</span> <span style="color: #000000;">lib</span><span style="color: #6a5acd;">/</span><span style="color: #000000;">image_science</span><span style="color: #6a5acd;">.</span><span style="color: #000000;">rb</span><span style="color: #6a5acd;">.</span><span style="color: #000000;">new</span>	<span style="color: #dd00dd;">2007</span><span style="color: #6a5acd;">-</span><span style="color: #dd00dd;">10</span><span style="color: #6a5acd;">-</span><span style="color: #dd00dd;">16</span> <span style="color: #dd00dd;">12</span><span style="color: #6a5acd;">:</span><span style="color: #dd00dd;">11</span><span style="color: #6a5acd;">:</span><span style="color: #dd00dd;">01.000000000</span> <span style="color: #6a5acd;">+</span><span style="color: #dd00dd;">0800</span><br /><span style="color: #009900;">@@</span> <span style="color: #6a5acd;">-</span><span style="color: #dd00dd;">150</span><span style="color: #6a5acd;">,</span><span style="color: #dd00dd;">6</span> <span style="color: #6a5acd;">+</span><span style="color: #dd00dd;">150</span><span style="color: #6a5acd;">,</span><span style="color: #dd00dd;">21</span> <span style="color: #009900;">@@</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #008b8b;">VALUE</span> <span style="color: #000000;">result</span> <span style="color: #6a5acd;">=</span> <span style="color: #008b8b;">Qnil</span><span style="color: #6a5acd;">;</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #000000;">int</span> <span style="color: #000000;">flags</span> <span style="color: #6a5acd;">=</span> <span style="color: #000000;">fif</span> <span style="color: #6a5acd;">==</span> <span style="color: #008b8b;">FIF_JPEG</span> <span style="color: #6a5acd;">?</span> <span style="color: #008b8b;">JPEG_ACCURATE</span> <span style="color: #6a5acd;">:</span> <span style="color: #dd00dd;">0</span><span style="color: #6a5acd;">;</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">if</span></span> <span style="color: #6a5acd;">(</span><span style="color: #000000;">bitmap</span> <span style="color: #6a5acd;">=</span> <span style="color: #008b8b;">FreeImage_Load</span><span style="color: #6a5acd;">(</span><span style="color: #000000;">fif</span><span style="color: #6a5acd;">,</span> <span style="color: #000000;">input</span><span style="color: #6a5acd;">,</span> <span style="color: #000000;">flags</span><span style="color: #6a5acd;">))</span> <span style="color: #6a5acd;">{</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #008b8b;">FITAG</span> <span style="color: #6a5acd;">*</span><span style="color: #000000;">tagValue</span> <span style="color: #6a5acd;">=</span> <span style="color: #008b8b;">NULL</span><span style="color: #6a5acd;">;</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #008b8b;">FreeImage_GetMetadata</span><span style="color: #6a5acd;">(</span><span style="color: #008b8b;">FIMD_EXIF_MAIN</span><span style="color: #6a5acd;">,</span> <span style="color: #000000;">bitmap</span><span style="color: #6a5acd;">,</span> <span style="color: #6a5acd;">&quot;</span><span style="color: #dd00dd;">Orientation</span><span style="color: #6a5acd;">&quot;,</span> <span style="color: #6a5acd;">&amp;</span><span style="color: #000000;">tagValue</span><span style="color: #6a5acd;">);</span> <br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #000000;">switch</span> <span style="color: #6a5acd;">(</span><span style="color: #000000;">tagValue</span> <span style="color: #6a5acd;">==</span> <span style="color: #008b8b;">NULL</span> <span style="color: #6a5acd;">?</span> <span style="color: #dd00dd;">0</span> <span style="color: #6a5acd;">:</span> <span style="color: #6a5acd;">*((</span><span style="color: #000000;">short</span> <span style="color: #6a5acd;">*)</span> <span style="color: #008b8b;">FreeImage_GetTagValue</span><span style="color: #6a5acd;">(</span><span style="color: #000000;">tagValue</span><span style="color: #6a5acd;">)))</span> <span style="color: #6a5acd;">{</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">case</span></span> <span style="color: #dd00dd;">6</span><span style="color: #6a5acd;">:</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #000000;">bitmap</span> <span style="color: #6a5acd;">=</span> <span style="color: #008b8b;">FreeImage_RotateClassic</span><span style="color: #6a5acd;">(</span><span style="color: #000000;">bitmap</span><span style="color: #6a5acd;">,</span> <span style="color: #dd00dd;">270</span><span style="color: #6a5acd;">);</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">break</span></span><span style="color: #6a5acd;">;</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">case</span></span> <span style="color: #dd00dd;">3</span><span style="color: #6a5acd;">:</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #000000;">bitmap</span> <span style="color: #6a5acd;">=</span> <span style="color: #008b8b;">FreeImage_RotateClassic</span><span style="color: #6a5acd;">(</span><span style="color: #000000;">bitmap</span><span style="color: #6a5acd;">,</span> <span style="color: #dd00dd;">180</span><span style="color: #6a5acd;">);</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">break</span></span><span style="color: #6a5acd;">;</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">case</span></span> <span style="color: #dd00dd;">8</span><span style="color: #6a5acd;">:</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #000000;">bitmap</span> <span style="color: #6a5acd;">=</span> <span style="color: #008b8b;">FreeImage_RotateClassic</span><span style="color: #6a5acd;">(</span><span style="color: #000000;">bitmap</span><span style="color: #6a5acd;">,</span> <span style="color: #dd00dd;">90</span><span style="color: #6a5acd;">);</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">break</span></span><span style="color: #6a5acd;">;</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #000000;">default</span><span style="color: #6a5acd;">:</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">break</span></span><span style="color: #6a5acd;">;</span><br /><span style="color: #6a5acd;">+</span>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<span style="color: #6a5acd;">}</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; <span style="color: #000000;">result</span> <span style="color: #6a5acd;">=</span> <span style="color: #000000;">wrap_and_yield</span><span style="color: #6a5acd;">(</span><span style="color: #000000;">bitmap</span><span style="color: #6a5acd;">,</span> <span style="color: #008b8b;">self</span><span style="color: #6a5acd;">,</span> <span style="color: #000000;">fif</span><span style="color: #6a5acd;">);</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #6a5acd;">}</span><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <span style="color: #a52a2a;"><span class="keyword" style="font-weight: bold;">return</span></span> <span style="color: #000000;">result</span><span style="color: #6a5acd;">;</span>
</pre>

<p>What's done here (for both) is that images loaded into memory will be checked for orientation information <em>and have its orientation corrected if possible</em> (otherwise its left untouched). In memory. So all your image operations like &quot;width&quot;, &quot;resize&quot; will be magically &quot;correct&quot;. </p>

<p>No modifications required to your routine. Heck, you can even pretend the whole scenario never existed!</p>

