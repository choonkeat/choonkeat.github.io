---
layout: post
title: HpricotForms
published: true
category:
- rails
---

<p>Since the introduction of <a href="http://redhanded.hobix.com/inspect/hpricot01.html">Hpricot</a>, the snazzy and fast Ruby parser for HTML, I've been meaning to give it a whirl - the API looks yummy. Now, as I'm doing more testing and validation stuff at work, such a need has come. Back in Javaland, when I need to navigate or test web apps by code, submit forms and do other web bot stuff, I turn to <a href="http://htmlunit.sourceforge.net/gettingStarted.html">HtmlUnit</a>. The api is simply awesome and won me over immediately. So if you're still stuck in Java, do give it a look.</p> <p>Anyways, though the whole testing harness of Rails is a godsend, I started to miss some of those HtmlUnit goodies - pulling out a Form object from a visited page, setting the fields values and submitting it.. and getting back a Page. So, this is what I've come up with for use in functional tests:<br /> </p> <pre><span class="keyword">def </span><span class="method">test_login_logout</span><br />   <span class="ident">page</span> <span class="punct">=</span> <span class="ident">get</span> <span class="symbol">:new</span>            <span class="comment"># first, let's get to the login page</span><br />   <span class="ident">form</span> <span class="punct">=</span> <span class="ident">page</span><span class="punct">.</span><span class="ident">forms</span><span class="punct">.</span><span class="ident">first</span>    <span class="comment"># next, get a reference to the form</span><br />   <span class="comment"># form.field_names =&gt; [&quot;user[login]&quot;, &quot;user[password]&quot;]</span><br />                              <span class="comment"># form.field_names returns you the input fields</span><br />                              <span class="comment"># available in the form</span><br /> <br />   <span class="ident">form</span><span class="punct">[&quot;</span><span class="string">user[login]</span><span class="punct">&quot;]</span>    <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">Joe</span><span class="punct">&quot;</span><br />   <span class="ident">form</span><span class="punct">[&quot;</span><span class="string">user[password]</span><span class="punct">&quot;]</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">topsecret</span><span class="punct">&quot;</span><br />   <span class="ident">page</span> <span class="punct">=</span> <span class="ident">form</span><span class="punct">.</span><span class="ident">submit</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span>   <span class="comment"># after setting the form values, submit it</span><br />                              <span class="comment"># 'page' now references the page after login</span><br />   <span class="ident">assert_response</span> <span class="symbol">:success</span><br />   <span class="comment"># page.links               # returns you an array of links found on the page</span><br /> <br />   <span class="ident">page</span> <span class="punct">=</span> <span class="ident">page</span><span class="punct">.</span><span class="ident">links</span><span class="punct">(&quot;</span><span class="string">@id='signout'</span><span class="punct">&quot;).</span><span class="ident">click</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span><br />                              <span class="comment"># locate the sign-out link by its html id</span><br />                              <span class="comment"># and click it</span><br />   <span class="ident">assert_response</span> <span class="symbol">:success</span><br /> <span class="keyword">end</span> </pre> <p>Can't say its a replica of HtmlUnit... but it does meet my needs for now. Notice we didn't need to explicitly handle things like session or where the form submits to. It simply goes to where its supposed to go - as rendered by the view. And yes, as you do submit() and click() you might actually cross different controllers. <a href="http://choonkeat.svnrepository.com/svn/rails-plugins/hpricot_forms/">HpricotForms</a> handles that for you. <br /> <br /> The main thing I like about this API is that the field names in the form are real. If you're careless like me, and modify your action templates (.rhtml files) but forgot to change both your controller and test, traditionally your test will still pass because you were passing in parameters explicitly, e.g.<br /> </p> <pre><span class="ident">post</span> <span class="symbol">:login</span><span class="punct">,</span> <span class="punct">{</span><span class="symbol">:user</span> <span class="punct">=&gt;</span> <span class="punct">{</span><span class="symbol">:login</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">Joe</span><span class="punct">&quot;,</span> <span class="symbol">:password</span> <span class="punct">=&gt;</span> <span class="punct">&quot;</span><span class="string">topsecret</span><span class="punct">&quot;}}</span><br /> </pre> <p>even though your HTML form fields were changed to &quot;account[login]&quot; and &quot;account[passwd]&quot;. But <a href="http://choonkeat.svnrepository.com/svn/rails-plugins/hpricot_forms/">HpricotForms</a> will raise an exception when you try to set values into fields that does not exist in the rendered form. <br /> </p> <p><a href="http://choonkeat.svnrepository.com/svn/rails-plugins/hpricot_forms/">HpricotForms</a> doesn't add new assert_xxx methods to your test environment since I personally think we've had enough already. It merely deals with navigation. I'm sure programmers out there are capable enough to do their own assertions when they need it.</p> <pre>script/plugin install <a href="http://choonkeat.svnrepository.com/svn/rails-plugins/hpricot_forms">http://choonkeat.svnrepository.com/svn/rails-plugins/hpricot_forms</a> </pre>   <p>Note: <strike>It appears that HpricotForms only work on <a href="http://wiki.rubyonrails.com/rails/pages/EdgeRails">Edge Rails</a>, with <a href="http://svn.jamisbuck.org/rails-plugins/simply_restful/">simply_restful</a> plugin. This is due to the routing changes.</strike> Works with Rails 1.1.4 and Edge Rails. <a href="http://choonkeat.svnrepository.com/rails-plugins/trac.cgi">Feedback</a> is welcome.<br />  </p>   <p><strong>Update</strong></p> <p>Added form.extend!(partial) to allow extending the formfields &nbsp;with a separate HTTP request. i.e. if your form appends fields via xmlHttpRequest, you can now say</p><pre><span class="ident">form</span> <span class="punct">=</span> <span class="ident">page</span><span class="punct">.</span><span class="ident">forms</span><span class="punct">.</span><span class="ident">first</span><br /><span class="ident">form</span><span class="punct">.</span><span class="ident">field_names</span> 	 <span class="comment"># =&gt; [&quot;email[0]&quot;] </span><br />                 	 <span class="comment"># the original form only has 1 field</span><br /><span class="ident">form</span><span class="punct">[&quot;</span><span class="string">email[0]</span><span class="punct">&quot;]</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">email1</span><span class="punct">&quot;</span><br /><br /><span class="ident">form</span><span class="punct">.</span><span class="ident">extend!</span><span class="punct">(</span><span class="ident">get</span> <span class="symbol">:on_security_options_clicked</span><span class="punct">)</span> <span class="keyword">do</span><br />    <span class="ident">form</span><span class="punct">.</span><span class="ident">field_names</span>     <span class="comment"># =&gt; [&quot;email[0]&quot;, &quot;ssl&quot;] </span><br />	                 <span class="comment"># the new fields from the partial is </span><br />    	                 <span class="comment"># appended into our form object. </span><br />    <span class="ident">form</span><span class="punct">[&quot;</span><span class="string">ssl</span><span class="punct">&quot;]</span> <span class="punct">=</span> <span class="punct">&quot;</span><span class="string">true</span><span class="punct">&quot;</span><br /><span class="keyword">end</span><br /><span class="ident">page</span> <span class="punct">=</span> <span class="ident">form</span><span class="punct">.</span><span class="ident">submit</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span> <span class="comment"># the combined form will be submitted</span></pre><p>Also, to help kick off the writing of code, form.to_code will print out a series of variable assignment satements based on the default values from the form, e.g. </p><pre><span class="ident">form</span> <span class="punct">=</span> <span class="ident">page</span><span class="punct">.</span><span class="ident">forms</span><span class="punct">.</span><span class="ident">first</span><br /><span class="ident">puts</span> <span class="ident">form</span><span class="punct">.</span><span class="ident">to_code</span><br />		<br /><span class="comment"># this prints lines of Ruby code like:</span><br /><span class="comment"># </span><br /><span class="comment"># form[&quot;from&quot;] = &quot;sender&quot;</span><br /><span class="comment"># form[&quot;email[0]&quot;] = &quot;email1&quot; </span><br /><span class="comment"># form[&quot;options[]&quot;] = [&quot;html&quot;, &quot;read-receipt&quot;]</span></pre>

