---
layout: post
title: Black Magick
published: true
category:
- ruby
---

<p>Some months ago, I encountered a weird problem where a ImageMagick/RMagick application was producing black images on my MacBook Pro. The same code was running mighty fine in production and all other servers. </p><blockquote><pre>require <span class="s"><span class="dl">'</span><span class="k">RMagick</span><span class="dl">'</span></span><br /><br /><span class="c"># Load a &quot;Base image&quot;</span><br />canvas = <span class="co">Magick</span>::<span class="co">ImageList</span>.new.from_blob(open(<span class="s"><span class="dl">&quot;</span><span class="k">logo.gif</span><span class="dl">&quot;</span></span>) {|f| f.read})<br /><br /><span class="c"># Layer another image over the base image - by making the 'background' </span><br /><span class="c"># of this layer transparent, the base image will appear behind the text</span><br /><span class="c"># caption nicely</span><br />canvas &lt;&lt; <span class="co">Magick</span>::<span class="co">Image</span>.read(<span class="s"><span class="dl">&quot;</span><span class="k">caption:Text over transparent background!</span><span class="dl">&quot;</span></span>) { <br />&nbsp; <span class="pc">self</span>.size = <span class="s"><span class="dl">&quot;</span><span class="il"><span class="idl">#{</span>canvas.first.columns<span class="idl">}</span></span><span class="dl">&quot;</span></span>;<br />&nbsp; <span class="pc">self</span>.pointsize = <span class="i">60</span><br />&nbsp; <span class="pc">self</span>.background_color = <span class="c">'#000000FF'</span><br /><span class="s"><span class="dl">&nbsp;</span></span>}.first<br /><br /><span class="c"># Flatten everything, and export as a GIF </span><br /><span class="c"># (GIMP / Photoshop users will be very familiar with what this step is about)</span><br />canvas.flatten_images.write(<span class="s"><span class="dl">&quot;</span><span class="k">logo-output.gif</span><span class="dl">&quot;</span></span>)</pre></blockquote><p>Since ImageMagick/RMagick has (to me) a hairy reputation regarding installation, version compatibility, etc, I'd chucked the issue aside as yet-another-install-issue to be solved next time.</p>

<p>Well, today is that <em>next time</em>. A new server was producing black images as well. <a href="http://sukantahazra.blogspot.com/">Sukanta</a> guessed it could be a problem with 64bit OS (oh.. <a href="http://www.apple.com/macosx/features/64bit/">Doh</a>) and suggested I write the tiniest Ruby script to replicate the problem and he'll debug from there.</p>

<p>By the time <a href="http://pastie.caboo.se/96085">that tiniest script</a> was written, the bug had revealed itself. The culprit was setting background_color to #000000FF - which the documentation had helpfully noted</p><blockquote><p><span class="content withoutphoto"><span class="text">Hint:&nbsp; You can specify the transparent color as &quot;none&quot;, &quot;transparent&quot;, or &quot;#000000ff&quot;<a href="http://r1.sharedcopy.com/72aftu5#shcp1"> <sup>link Â»</sup></a></span></span></p></blockquote><p>Guess not! Only &quot;none&quot; and &quot;transparent&quot; would continue to work.</p><br /> 

