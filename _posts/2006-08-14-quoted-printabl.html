---
layout: post
title: 'Quoted-Printable: Bitten for the N-th time!'
published: true
category:
- ruby
---

<p> <p>I knew I'd handled this before, but still I'd forgotten what was going on. Searching the web was <a href="http://www.google.com/search?q=tmail%20unquote%20body%20quoted-printable%20">fruitless</a> - everyone seem happy to simply use str.unpack(&quot;M*&quot;) (aka TMail::Mail.unquoted_body when &quot;quoted-printable&quot;) for getting unquoted body from an email part that is &quot;quoted-printable&quot;.</p> <p>Perhaps I'm just searching for the wrong terms... if so, then to ensure I'll hit my own result next time, I might as well be the one to put up a post using these terms that I might use:&nbsp; tmail unquote body quoted-printable decode truncated</p> <p>The problem is, I have a email.body (e.g. variable str) that looks like this: <br /> </p> <pre><span class="ident">irb</span><span class="punct">(</span><span class="ident">main</span><span class="punct">):</span><span class="number">002</span><span class="punct">:</span><span class="number">0</span><span class="punct">&gt;</span> <span class="ident">puts</span> <span class="ident">str</span><br /> <span class="constant">This</span> <span class="ident">is</span> <span class="ident">a</span><br /> <span class="punct">=</span><span class="number">20</span><br /> <span class="ident">multiline</span> <span class="ident">te</span><span class="punct">=</span><br /> <span class="ident">xt</span><br /> <span class="punct">=</span><span class="number">20</span><br /> <span class="ident">string</span> <span class="ident">text</span><br /> <span class="punct">=&gt;</span> <span class="constant">nil</span></pre> <p>So far so good. Now I perform an unpack (aka email.unquoted_body) <br /> </p> <pre><span class="ident">irb</span><span class="punct">(</span><span class="ident">main</span><span class="punct">):</span><span class="number">003</span><span class="punct">:</span><span class="number">0</span><span class="punct">&gt;</span> <span class="ident">puts</span> <span class="ident">str</span><span class="punct">.</span><span class="ident">unpack</span><span class="punct">(&quot;</span><span class="string">M*</span><span class="punct">&quot;)</span> <span class="comment"># aka TMail::Mail.unquoted_body when &quot;quoted-printable&quot;</span><br /> <span class="constant">This</span> <span class="ident">is</span> <span class="ident">a</span><br /> <br /> <span class="ident">multiline</span> <span class="ident">te</span><br /> <span class="punct">=&gt;</span> <span class="constant">nil</span></pre> <p>WTF? What happened to the 3rd line of text? *shrugs* but if I do some dos2unix on the string... <br /> </p> <pre><span class="ident">irb</span><span class="punct">(</span><span class="ident">main</span><span class="punct">):</span><span class="number">004</span><span class="punct">:</span><span class="number">0</span><span class="punct">&gt;</span> <span class="ident">puts</span> <span class="ident">str</span><span class="punct">.</span><span class="ident">gsub</span><span class="punct">(/</span><span class="regex"><span class="escape">\r\n</span></span><span class="punct">/,</span> <span class="punct">&quot;\n&quot;</span><span class="punct">).</span><span class="ident">unpack</span><span class="punct">(&quot;</span><span class="string">M*</span><span class="punct">&quot;)</span><br /> <span class="constant">This</span> <span class="ident">is</span> <span class="ident">a</span><br /> <br /> <span class="ident">multiline</span> <span class="ident">text</span><br /> <br /> <span class="ident">string</span> <span class="ident">text</span><br /> <span class="punct">=&gt;</span> <span class="constant">nil</span></pre> <p>Bah! The email did come from hotmail.com so I'm biased to think <em>they</em> got it wrong instead of the stdlib. </p> <p>Update: <a href="http://www.freesoft.org/CIE/RFC/1521/6.htm">Hmmmmmm..</a> </p> <pre>Note that many implementations may elect to encode the local<br />representation of various content types directly, as described in<br />Appendix G.  In particular, this may apply to plain text material<br />on systems that use newline conventions other than CRLF<br />delimiters. Such an implementation is permissible, but the<br />generation of line breaks must be generalized to account for the<br />case where alternate representations of newline sequences are<br />used.</pre><pre>quoted-printable := ([*(ptext / SPACE / TAB) ptext] [&quot;=&quot;] CRLF)<br />         ; Maximum line length of 76 characters excluding CRLF</pre><p>Update 2: Ruby stdlib is broken <a href="http://72.14.235.104/search?q=cache:dAM_bdbXon8J:blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-dev/28601%3Fhelp+ruby+unpack+CRLF&amp;hl=en&amp;lr=&amp;strip=1">for unpack</a>. </p> <pre>&nbsp;</pre></p>

