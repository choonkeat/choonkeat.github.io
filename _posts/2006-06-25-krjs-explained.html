---
layout: post
title: KRJS Explained
published: true
category:
- krjs
---

<p>Regarding KRJS, I've been asked &quot;Hmm.. so you moved the javascript to the controller... what's the benefit?&quot;. I'll try to briefly illustrate the benefits here with some Rails/RJS code - <strong>the codes in this example are broken, bugs or simply wrong</strong> but that's not the point - hopefully you'll get the drift.<br /><br /><span style="font-weight: bold">The Problem:</span> Given a textfield and a blank div in Rails, let's do a <a target="_blank" onclick="return top.js.OpenExtLink(window,event,this)" href="http://www.google.com/webhp?complete=1"><span style="font-style: italic">google suggest-ish</span> </a> feature<br /><span style="font-family: courier new,monospace">&lt;%= text_field_tag '<span style="font-weight: bold">query</span>' %&gt;</span><br /><span style="font-family: courier new,monospace"> &lt;div id=&quot;<span style="font-weight: bold">placeholder</span>&quot;&gt;&lt;/div&gt;</span><br /><br /><font size="3"><strong>Method #1</strong></font><br />1. observe your textfield with javascript:<br /><span style="font-family: courier new,monospace"> &lt;script&gt;</span><br /><span style="font-family: courier new,monospace">&nbsp; // every 3 seconds, check changes typed into textfield</span><br /> <span style="font-family: courier new,monospace">&nbsp; my_observer('query', 3, 'my_call_to_server');</span><br /><br /><span style="font-family: courier new,monospace"> &nbsp; // when called, sends server a request and updates HTML with</span><br /><span style="font-family: courier new,monospace">&nbsp; // response data</span><br /> <span style="font-family: courier new,monospace">&nbsp; function my_call_to_server(query) {</span><br /><span style="font-family: courier new,monospace">&nbsp;&nbsp;&nbsp; data = Ajax.get(&quot;http://host:port/my_script?query=&quot; + query);</span><br /><span style="font-family: courier new,monospace">&nbsp;&nbsp;&nbsp; getElementById('placeholder').innerHtml = data;</span><br /> <span style="font-family: courier new,monospace">&nbsp; }</span><br /><span style="font-family: courier new,monospace">&lt;/script&gt;</span><br /> <br />But let's be fair, with Rails can cut it down and even get cross-browser compatibility:<br /><span style="font-family: courier new,monospace">&lt;%=</span><br /><span style="font-family: courier new,monospace"> observe_field('<span style="font-weight: bold">query</span>',</span><br /><span style="font-family: courier new,monospace">&nbsp; { :url =&gt; { :action =&gt; '<span style="font-weight: bold"> my_script</span>'}, </span><br /><span style="font-family: courier new,monospace">&nbsp; :frequency =&gt; <span style="font-weight: bold">3</span>,</span><br /> <span style="font-family: courier new,monospace">&nbsp; :with =&gt;'<span style="font-weight: bold">query</span>',</span><br /><span style="font-family: courier new,monospace">&nbsp; :update =&gt; ' <span style="font-weight: bold">placeholder</span>')</span><br /><span style="font-family: courier new,monospace">%&gt;</span><br /><br />2. Next, handle the Ajax.get on server and spits out HTML. <br /><span style="font-family: courier new,monospace">def my_script</span><br /><span style="font-family: courier new,monospace">&nbsp; search_results&nbsp; = search_for(params['query'])</span> <br /><span style="font-family: courier new,monospace">&nbsp; render text: =&gt; search_results.to_html</span><br /><span style="font-family: courier new,monospace"> end</span><br /><br />Notice the bold portions, these will come back to haunt you when you have many ajax pages - because you're forced to tie up the whole logic (observe '<span style="font-weight: bold">query</span>' every  <span style="font-weight: bold">3</span> seconds, send to server '<span style="font-weight: bold">my_script</span>', update '<span style="font-weight: bold">placeholder</span>') all inside the HTML template. Dang! These will haunt you when you need to change or add logic (I'm sure you've experienced it before) <br /><br /><font size="3"><strong>Method #2</strong></font><br />1. Again, observe your textfield (notice the omitted <span style="font-family: courier new,monospace">:update</span> option)<br /><span style="font-family: courier new,monospace"> &lt;%=</span><br /><span style="font-family: courier new,monospace">observe_field('</span><span style="font-weight: bold; font-family: courier new,monospace">query</span><span style="font-family: courier new,monospace"> ',</span><br /><span style="font-family: courier new,monospace">&nbsp; { :url =&gt; { :action =&gt; '</span><span style="font-weight: bold; font-family: courier new,monospace">my_script </span><span style="font-family: courier new,monospace">'}, </span><br /><span style="font-family: courier new,monospace">&nbsp; :frequency =&gt; </span><span style="font-weight: bold; font-family: courier new,monospace"> 3</span><span style="font-family: courier new,monospace">,</span><br /><span style="font-family: courier new,monospace">&nbsp; :with =&gt;'</span><span style="font-weight: bold; font-family: courier new,monospace"> query</span><span style="font-family: courier new,monospace">')</span><br /><span style="font-family: courier new,monospace">%&gt;</span><br /><br />2. Handle the Ajax.get on server and use RJS to spit out JS (calling page will execute): <br /><span style="font-family: courier new,monospace">def my_script</span><br /><span style="font-family: courier new,monospace">&nbsp; search_results&nbsp; = search_for(params['query'])</span> <br /><span style="font-family: courier new,monospace">&nbsp; render update do |page|</span><br /><span style="font-family: courier new,monospace"> &nbsp;&nbsp;&nbsp; page.replace_html :placeholder, search_results.to_html</span><br /><span style="font-family: courier new,monospace"><br /><span style="font-style: italic">&nbsp;&nbsp;&nbsp; # 2 new whiz-bang features! </span></span><br /><span style="font-family: courier new,monospace; font-style: italic">&nbsp;&nbsp;&nbsp; page.replace_html :title, &quot;Suggestions for #{params['query']}&quot; </span><br /><span style="font-family: courier new,monospace; font-style: italic">&nbsp;&nbsp;&nbsp; </span><span style="font-family: courier new,monospace; font-style: italic"> </span><span style="font-family: courier new,monospace; font-style: italic">page.hide :advertisement_div </span><span style="font-family: courier new,monospace; font-style: italic">if <br /><span style="font-style: italic"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>User.find(@session[:user_id]).name == 'George'</span><span style="font-family: courier new,monospace; font-style: italic"><br /></span><span style="font-family: courier new,monospace"> &nbsp; end</span><br /><span style="font-family: courier new,monospace">end</span><br /><br />Notice lesser amount of bold portions in the template? No more hard coding to update 'placeholder', we're saying it only at the server side. In fact, its so easy to add more / change JS events with RJS, that I had easily added 2 extra features without any the template changes! To introduce / change features in method #1, you would have to modify the html template. <br /><br />Now, notice that last extra feature... It roughly means &quot;<span style="font-style: italic">Find current user in database, if the name is George, send an extra javascript event to hide the advertisement div</span> &quot;. Imagine the code you have to juggle if we're doing this on client side (method #1)!!<br /><br /><font size="3"><strong>Method #3</strong></font><br />NOW.. Let's have fun with KRJS<br />1. <br />2. Handle the Ajax.get on server and use RJS to spit out JS (calling page will execute): <br /><span style="font-family: courier new,monospace">def <span style="font-weight: bold">on_query_change_3</span></span><br /><span style="font-family: courier new,monospace">&nbsp;  </span><span style="font-family: courier new,monospace"># same code as method #2...</span><br /><span style="font-family: courier new,monospace"> end</span><br /><br /><span style="font-style: italic">Hey! There's no Step 1(tm)</span>. And step 2 is identical to method #2 (all benefits of RJS) except that our function has a specific naming convention. Absolutely no need to touch your template at all! The necessary javascripts in the HTML are inserted automatically when the template is rendered. <br /><br />Let's say we decide to change the JS event to <span style="font-family: courier new,monospace">onblur</span> instead of observing every 3 seconds... come, think what has to be done if we're using method #1 or #2? Ready? Change 1 file? 2 files? remove observe_field method, and replace with onblur event?... <br /><br />In KRJS, you simply rename your controller handler:<br /><span style="font-family: courier new,monospace">def <span style="font-weight: bold">on_query_blur</span></span><br /> <span style="font-family: courier new,monospace">&nbsp; </span><span style="font-family: courier new,monospace"># same code as method #2...</span><br /> <span style="font-family: courier new,monospace">end</span></p><p>Now, its not really performant right now... the time-savings is mostly conceptual as well as on the development time. The exact implementation could be evolved, no issue:</p><ul><li>detect external on_xxx.rjs files instead of clogging the controller with on_xxx methods&nbsp;</li><li>different behavior when in production mode</li><li>rake task to compile for production (faster to render)</li></ul><p>With KRJS, I can see lots of code-cutting with the many <a href="http://weblog.rubyonrails.org/2006/6/13/new-from-oreilly-rjs-templates-for-rails">RJS examples</a> out there. <a href="http://choonkeat.svnrepository.com/svn/rails-plugins/krjs/">Patches are welcome</a>.&nbsp;</p>

