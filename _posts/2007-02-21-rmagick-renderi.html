---
layout: post
title: 'RMagick: Rendering a chunk of lengthy text into a fixed size image, with a
  selected font color'
published: true
category:
- ruby
---
<p>Been using RMagick at work, and was required to do something that wasn't supported directly: Rendering a chunk of lengthy text into a fixed size image, with a selected font color. Quite strange actually, because as far as rendering text goes, I would've thought that's a common use case.<br />  </p>   <p>1. Selected font color</p>   <p>RMagick provides 2 ways of rendering text: Using the <a href="http://www.simplesystems.org/RMagick/doc/imusage.html#bi_format_list">caption builtin format</a> or <a href="http://www.simplesystems.org/RMagick/doc/draw.html#annotate">Draw#annotate</a>. Annotate loses since it doesn't do word-wrap, but caption does. So... DIY word-wrapping with annotate? Ugh. The kick is, I could get &quot;annotate&quot; to set the font color, I couldn't make &quot;caption&quot; do the same though the documentation says it can.<br />  </p>   <p>Tip #26 from the very valuable <a href="http://www.pragmaticprogrammer.com/ppbook/extracts/rule_list.html">Pragmatic Programmer</a> book is <br />   </p>      <blockquote>     <p>&quot;select&quot;&nbsp; Isn't Broken<br />   It is rare to find a bug in the OS or the compiler, or even a third-party product or library. The bug is most likely in the application.</p>   </blockquote>      <p>This refers to programmers jumping to conclusion that some strange bug is caused by bugs in the lower-level library / operating system just because he cannot figure how his own code would be faulty. When you can't find the bug in your code, operating under &quot;select is not broken&quot; mode means that you &quot;look again&quot; in your own code, turn it over, around and shake out the loose bits - you'll usually find its actually your own fault.</p>     <p>Operating under this mode has a few benefits. First, your colleagues will stop avoiding you. Secondly, you'll learn a hell lot about your own code, debugging and the underlying library you are using.&nbsp;However, when you've tried different ways, with the simplest possible piece of code (out of the context of your application) and it still doesn't work, it wouldn't hurt to question.<br />   <br />   Lucky me, the proverbial &quot;<a href="http://en.wikipedia.org/wiki/Asynchronous_I/O#Select.28.2Fpoll.29_loop">select</a>&quot; was indeed broken and Tim Hunter was blazing fast in his response. RMagick::Image::Info.fill= wasn't working in &quot;caption&quot; mode, but now it does. My rendered, word-wrapped text now has colors.</p>   <p>2. Rendering into a fixed size</p>   <p>Word wrap allows me to constrain my text into a specific width, however it doesn't trim my text properly height-wise. If the image height is shorter than the rendered result, text gets clipped mercilessly - sometimes halfway across the font, depending on your image height and font size. I didn't find any option for such trimming, neither could I google an off the shelf solution. So I wrote my own. And since I felt that this &quot;rendering a chunk of lengthy text into a fixed size image, with a selected font color&quot; thingy is a rather common use case, I guess I might as well put the code out. Feel free to contribute any suggestion to speed up the trimming:</p><pre><span class="comment">#</span><br /><span class="comment"># Generate Magick::Image objects from text</span><br /><span class="comment">#  * wraps text around width_constraint (pixels)</span><br /><span class="comment">#  * cuts off text (and appends '...') if it goes beyond height_constraint (pixels)</span><br /><span class="comment">#</span><br /><span class="comment"># Example</span><br /><span class="comment"># &lt;code&gt;</span><br /><span class="comment">#    require 'rmagick_text_util.rb'</span><br /><span class="comment">#    include RMagickTextUtil</span><br /><span class="comment">#    some_text = &quot;Hello world. This is a rather lengthy line &quot;      +</span><br /><span class="comment">#                &quot;and I'm not very sure how much will be cropped, &quot; +</span><br /><span class="comment">#                &quot;and how much will be left over. So, here goes!&quot;</span><br /><span class="comment">#</span><br /><span class="comment">#    image = render_cropped_text(some_text, 100, 50)</span><br /><span class="comment">#    image.write &quot;example_without_block.jpg&quot;</span><br /><span class="comment">#</span><br /><span class="comment">#    image = render_cropped_text(some_text, 100, 50) do |img|</span><br /><span class="comment">#       img.fill = &quot;#ff0000&quot; # this won't work until RMagick v1.15.3</span><br /><span class="comment">#       img.pointsize = 15</span><br /><span class="comment">#    end</span><br /><span class="comment">#    image.write &quot;example_with_block.jpg&quot;</span><br /><span class="comment"># &lt;/code&gt;</span><br /><span class="comment">#</span><br /><span class="ident">require</span> <span class="punct">'</span><span class="string">RMagick</span><span class="punct">'</span><br /><br /><span class="keyword">module </span><span class="module">RMagickTextUtil</span><br />    <span class="keyword">def </span><span class="method">render_cropped_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="ident">height_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />        <span class="ident">image</span> <span class="punct">=</span> <span class="ident">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />        <span class="keyword">if</span> <span class="ident">height_constraint</span> <span class="punct">&lt;</span> <span class="ident">image</span><span class="punct">.</span><span class="ident">rows</span><br />            <span class="ident">percent</span> <span class="punct">=</span> <span class="ident">height_constraint</span><span class="punct">.</span><span class="ident">to_f</span> <span class="punct">/</span> <span class="ident">image</span><span class="punct">.</span><span class="ident">rows</span><span class="punct">.</span><span class="ident">to_f</span><br />            <span class="ident">end_index</span> <span class="punct">=</span> <span class="punct">(</span><span class="ident">caption_text</span><span class="punct">.</span><span class="ident">size</span> <span class="punct">*</span> <span class="ident">percent</span><span class="punct">).</span><span class="ident">to_i</span>  <span class="comment"># takes a leap into cropping</span><br />            <span class="ident">image</span> <span class="punct">=</span> <span class="ident">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="ident">end_index</span><span class="punct">]</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string">...</span><span class="punct">&quot;,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />            <span class="keyword">while</span> <span class="ident">height_constraint</span> <span class="punct">&lt;</span> <span class="ident">image</span><span class="punct">.</span><span class="ident">rows</span> <span class="punct">&amp;&amp;</span> <span class="ident">end_index</span> <span class="punct">&gt;</span> <span class="number">0</span> <span class="comment"># reduce in big chunks until within range</span><br />                <span class="ident">end_index</span> <span class="punct">-=</span> <span class="number">80</span><br />                <span class="ident">image</span> <span class="punct">=</span> <span class="ident">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="ident">end_index</span><span class="punct">]</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string">...</span><span class="punct">&quot;,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />            <span class="keyword">end</span><br />            <span class="keyword">while</span> <span class="ident">height_constraint</span> <span class="punct">&gt;</span> <span class="ident">image</span><span class="punct">.</span><span class="ident">rows</span>                  <span class="comment"># lengthen in smaller steps until exceed</span><br />                <span class="ident">end_index</span> <span class="punct">+=</span> <span class="number">10</span><br />                <span class="ident">image</span> <span class="punct">=</span> <span class="ident">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="ident">end_index</span><span class="punct">]</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string">...</span><span class="punct">&quot;,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />            <span class="keyword">end</span><br />            <span class="keyword">while</span> <span class="ident">height_constraint</span> <span class="punct">&lt;</span> <span class="ident">image</span><span class="punct">.</span><span class="ident">rows</span> <span class="punct">&amp;&amp;</span> <span class="ident">end_index</span> <span class="punct">&gt;</span> <span class="number">0</span> <span class="comment"># reduce in baby steps until fit</span><br />                <span class="ident">end_index</span> <span class="punct">-=</span> <span class="number">1</span><br />                <span class="ident">image</span> <span class="punct">=</span> <span class="ident">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="ident">end_index</span><span class="punct">]</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string">...</span><span class="punct">&quot;,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />            <span class="keyword">end</span><br />        <span class="keyword">end</span><br />        <span class="ident">image</span><br />    <span class="keyword">end</span><br /><br />    <span class="keyword">def </span><span class="method">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />        <span class="constant">Magick</span><span class="punct">::</span><span class="constant">Image</span><span class="punct">.</span><span class="ident">read</span><span class="punct">(&quot;</span><span class="string">caption:<span class="expr">#{caption_text.to_s}</span></span><span class="punct">&quot;)</span> <span class="punct">{</span><br />            <span class="comment"># this wraps the text to fixed width</span><br />            <span class="constant">self</span><span class="punct">.</span><span class="ident">size</span> <span class="punct">=</span> <span class="ident">width_constraint</span><br />            <span class="comment"># other optional settings</span><br />            <span class="ident">block</span><span class="punct">.</span><span class="ident">call</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span> <span class="keyword">if</span> <span class="ident">block_given?</span><br />        <span class="punct">}.</span><span class="ident">first</span><br />    <span class="keyword">end</span><br /><span class="keyword">end</span></pre><p>Update: fixes infinite loop when empty string cannot satisfy height and width constraint</p>
