---
layout: post
title: 'KRJS: RJS without messing the Views'
published: true
category:
- krjs
---

<p>   <p>RJS is great and awesome. I use it quite regularly now. With RJS, I don't have to deal with <em>which parts of the page to update</em> in the rhtml files - I get to decide whilst in my controller using the nice and elegant <a href="http://codefluency.com/articles/2006/05/27/rails-views-render-update-not-rjs/">render :update</a>. Sweet. </p>             <p>But part of me wished I didn't have to even decide <em>which page elements are to be ajaxified</em>. I'd wish I could more easily enable a link, form or button to make ajax calls without going back and touching my html... <br />       </p>             <p>Oh well. </p>             <p>Introducing the <a href="http://choonkeat.svnrepository.com/svn/rails-plugins/krjs/">KRJS plugin</a>, with less than 60 lines of patch to Rails' ActionPack itself (which probably means bugs are aplenty, would slow production sites to a crawl, and that its fresh from the oven too)</p>             <p>To see KRJS in action (<em>so what does it do?</em>), generate a blank controller and index action:<br />   </p>     <pre><font color="#990000">.</font>/script/generate controller Sample index</pre>   <p>Give it a decent layout (include javascripts) by creating the file app/views/layouts/sample.rhtml<br />   </p>     <pre><font color="#990000">&lt;</font><font color="#990000">!</font>DOCTYPE html PUBLIC <font color="#ff0000">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</font><br />     <font color="#ff0000">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;</font><font color="#990000">&gt;</font><br />   <font color="#ff0000">&lt;html&gt;</font><br />   <font color="#ff0000">&lt;head&gt;</font><br />     <font color="#990000">&lt;</font><font color="#990000">%</font><font color="#990000">=</font> javascript_include_tag <font color="#990000">:</font>defaults <font color="#990000">%</font><font color="#990000">&gt;</font><br />   <font color="#ff0000">&lt;/head&gt;</font><br />   <font color="#ff0000">&lt;body&gt;</font><br />   <font color="#990000">&lt;</font><font color="#990000">%</font><font color="#990000">=</font> <font color="#009900">@content_for_layout</font> <font color="#990000">%</font><font color="#990000">&gt;</font><br />   <font color="#ff0000">&lt;/body&gt;</font><br />   <font color="#ff0000">&lt;/html&gt;</font> </pre>           <p>Create a sample form: <br />   </p>     <pre><font color="#990000">&lt;</font><font color="#990000">%</font><font color="#990000">=</font> <strong><font color="#000000">form_tag</font></strong><font color="#990000">(</font><font color="#ff0000">{</font><font color="#990000">:</font>action <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#ff0000">'submit'</font><font color="#ff0000">}</font><font color="#990000">,</font> <font color="#ff0000">{</font><font color="#990000">:</font>id <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#ff0000">'form'</font><font color="#ff0000">}</font><font color="#990000">)</font> <font color="#990000">%</font><font color="#990000">&gt;</font><br />     <font color="#990000">&lt;</font><font color="#990000">%</font><font color="#990000">=</font> text_field <font color="#ff0000">'account'</font><font color="#990000">,</font> <font color="#ff0000">'login'</font><font color="#990000">,</font> <font color="#990000">:</font>id <font color="#990000">=</font><font color="#990000">&gt;</font> <font color="#ff0000">'account-new-login'</font> <font color="#990000">%</font><font color="#990000">&gt;</font><font color="#990000">&lt;</font>br <font color="#990000">/</font><font color="#990000">&gt;</font><br />     <font color="#990000">&lt;</font><font color="#990000">%</font><font color="#990000">=</font> submit_tag <font color="#ff0000">'Login'</font> <font color="#990000">%</font><font color="#990000">&gt;</font><br />   <font color="#990000">&lt;</font><font color="#990000">%</font><font color="#990000">=</font> end_form_tag <font color="#990000">%</font><font color="#990000">&gt;</font> </pre>          <p>This will be the last time we're touch the Views. If you visit the page now, you should see a simple form. This is the most basic Rails app. It will be our mickey mouse app for this session:<br />   </p>             <p><a title="Photo Sharing" href="http://www.flickr.com/photos/choonkeat/165073750/"><img width="240" height="93" border="0" alt="KRJS walkthru: Default form" src="http://static.flickr.com/49/165073750_19cba41a79_m.jpg" /></a></p>             <p>Clicking on Login leads you to an even simpler error page:</p>           <p><a title="Photo Sharing" href="http://www.flickr.com/photos/choonkeat/165073835/"><img width="240" height="94" border="0" alt="KRJS walkthru: Default page after submitting form" src="http://static.flickr.com/64/165073835_c5d9f5608a_m.jpg" /></a></p>             <p>This is because we didn't have any code to handle the form submit. Don't let that stop us web2.0-ers, let's ajaxify it anyways! First, install the <a href="http://choonkeat.svnrepository.com/svn/rails-plugins/krjs/">KRJS plugin</a> </p><pre><font color="#990000">.</font>/script/plugin install http://choonkeat.svnrepository.com/svn/rails-plugins/krjs/</pre><p>and <strong>restart your server</strong>.</p>         <p>Now, try to view the page, and click on the Login button.... same error page. Good! That means KRJS didn't mess up the original app. Now let's add a new method into the controller, app/controllers/sample_controller.rb<br />     </p>         <pre>  <strong><font color="#0000ff">def</font></strong> on_form_submit<br />       render <font color="#990000">:</font>update <strong><font color="#0000ff">do</font></strong> <font color="#990000">|</font>page<font color="#990000">|</font><br />         page<font color="#990000">.</font>insert_html <font color="#990000">:</font>after<font color="#990000">,</font> <font color="#ff0000">'form'</font><font color="#990000">,</font> CGI<font color="#990000">.</font><strong><font color="#000000">escapeHTML</font></strong><font color="#990000">(</font>params<font color="#990000">.</font>inspect<font color="#990000">)</font><br />       <strong><font color="#0000ff">end</font></strong><br />     <strong><font color="#0000ff">end</font></strong></pre>   <p>&nbsp;</p>         <p>Refresh the page, and click on Login</p>         <p><a title="Photo Sharing" href="http://www.flickr.com/photos/choonkeat/165073881/"><img width="240" height="93" border="0" alt="KRJS walkthru: Result page after installing KRJS and clicking form" src="http://static.flickr.com/45/165073881_98a6576eac_m.jpg" /></a></p>         <p>As you can see, the form has become ajaxified - to update the page instead of sending the browser to a new location - by merely adding a new corresponding method in the controller! How about adding this to the controller:</p>       <p>&nbsp;</p>     <pre>  <strong><font color="#0000ff">def</font></strong> on_account_login_blur<br />       render <font color="#990000">:</font>update <strong><font color="#0000ff">do</font></strong> <font color="#990000">|</font>page<font color="#990000">|</font><br />         page<font color="#990000">.</font>insert_html <font color="#990000">:</font>after<font color="#990000">,</font> <font color="#ff0000">'form'</font><font color="#990000">,</font> CGI<font color="#990000">.</font><strong><font color="#000000">escapeHTML</font></strong><font color="#990000">(</font>params<font color="#990000">.</font>inspect<font color="#990000">)</font><br />       <strong><font color="#0000ff">end</font></strong><br />     <strong><font color="#0000ff">end</font></strong></pre>   <p>&nbsp;</p>       <p>Refresh the page, type something into the textfield and TAB away from the field:<br />   </p>       <p><a title="Photo Sharing" href="http://www.flickr.com/photos/choonkeat/165073907/"><img width="240" height="94" border="0" alt="KRJS walkthru: Result page after losing focus on text field" src="http://static.flickr.com/44/165073907_898d68f271_m.jpg" /></a></p>             <p>Yea, KRJS registers onBlur events as well. In fact, it'll register onClick, onSubmit, onWatever, onYouwant because it doesn't really care. All that matters is your HTML element's ID attribute. <a href="http://choonkeat.svnrepository.com/svn/rails-plugins/krjs/">KRJS</a> currently identifies xhr actions by naming conventions, hence it will probably be most convenient to be used with <a href="http://choonkeat.svnrepository.com/svn/rails-plugins/dashed_dom_id/">dashed_</a><a href="http://choonkeat.svnrepository.com/svn/rails-plugins/dashed_dom_id/">dom_id plugin</a>.&nbsp;</p>     <p>Go ahead, give it a spin. I'm going to sleep.. hope I don't wake into a world of horror... <br />   </p><p>[Updated plugin links]&nbsp;</p></p>

