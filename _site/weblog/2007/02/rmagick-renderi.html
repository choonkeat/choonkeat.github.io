<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>RMagick: Rendering a chunk of lengthy text into a fixed size image, with a selected font color | The Devel!</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="RMagick: Rendering a chunk of lengthy text into a fixed size image, with a selected font color" />
<meta name="author" content="choonkeat" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Been using RMagick at work, and was required to do something that wasn&#39;t supported directly: Rendering a chunk of lengthy text into a fixed size image, with a selected font color. Quite strange actually, because as far as rendering text goes, I would&#39;ve thought that&#39;s a common use case. 1. Selected font color RMagick provides 2 ways of rendering text: Using the caption builtin format or Draw#annotate. Annotate loses since it doesn&#39;t do word-wrap, but caption does. So... DIY word-wrapping with annotate? Ugh. The kick is, I could get &quot;annotate&quot; to set the font color, I couldn&#39;t make &quot;caption&quot; do the same though the documentation says it can. Tip #26 from the very valuable Pragmatic Programmer book is &lt;blockquote&gt; &lt;p&gt;&amp;quot;select&amp;quot;&amp;nbsp; Isn&#39;t Broken&lt;br /&gt; It is rare to find a bug in the OS or the compiler, or even a third-party product or library. The bug is most likely in the application.&lt;/p&gt; &lt;/blockquote&gt; &lt;p&gt;This refers to programmers jumping to conclusion that some strange bug is caused by bugs in the lower-level library / operating system just because he cannot figure how his own code would be faulty. When you can&#39;t find the bug in your code, operating under &amp;quot;select is not broken&amp;quot; mode means that you &amp;quot;look again&amp;quot; in your own code, turn it over, around and shake out the loose bits - you&#39;ll usually find its actually your own fault.&lt;/p&gt; &lt;p&gt;Operating under this mode has a few benefits. First, your colleagues will stop avoiding you. Secondly, you&#39;ll learn a hell lot about your own code, debugging and the underlying library you are using.&amp;nbsp;However, when you&#39;ve tried different ways, with the simplest possible piece of code (out of the context of your application) and it still doesn&#39;t work, it wouldn&#39;t hurt to question.&lt;br /&gt; &lt;br /&gt; Lucky me, the proverbial &amp;quot;&lt;a href=&quot;http://en.wikipedia.org/wiki/Asynchronous_I/O#Select.28.2Fpoll.29_loop&quot;&gt;select&lt;/a&gt;&amp;quot; was indeed broken and Tim Hunter was blazing fast in his response. RMagick::Image::Info.fill= wasn&#39;t working in &amp;quot;caption&amp;quot; mode, but now it does. My rendered, word-wrapped text now has colors.&lt;/p&gt; &lt;p&gt;2. Rendering into a fixed size&lt;/p&gt; &lt;p&gt;Word wrap allows me to constrain my text into a specific width, however it doesn&#39;t trim my text properly height-wise. If the image height is shorter than the rendered result, text gets clipped mercilessly - sometimes halfway across the font, depending on your image height and font size. I didn&#39;t find any option for such trimming, neither could I google an off the shelf solution. So I wrote my own. And since I felt that this &amp;quot;rendering a chunk of lengthy text into a fixed size image, with a selected font color&amp;quot; thingy is a rather common use case, I guess I might as well put the code out. Feel free to contribute any suggestion to speed up the trimming:&lt;/p&gt;&lt;pre&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# Generate Magick::Image objects from text&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# * wraps text around width_constraint (pixels)&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# * cuts off text (and appends &#39;...&#39;) if it goes beyond height_constraint (pixels)&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# Example&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;lt;code&amp;gt;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# require &#39;rmagick_text_util.rb&#39;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# include RMagickTextUtil&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# some_text = &amp;quot;Hello world. This is a rather lengthy line &amp;quot; +&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;quot;and I&#39;m not very sure how much will be cropped, &amp;quot; +&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;quot;and how much will be left over. So, here goes!&amp;quot;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image = render_cropped_text(some_text, 100, 50)&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image.write &amp;quot;example_without_block.jpg&amp;quot;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image = render_cropped_text(some_text, 100, 50) do |img|&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# img.fill = &amp;quot;#ff0000&amp;quot; # this won&#39;t work until RMagick v1.15.3&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# img.pointsize = 15&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# end&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image.write &amp;quot;example_with_block.jpg&amp;quot;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;lt;/code&amp;gt;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;ident&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;RMagick&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&#39;&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;span class=&quot;keyword&quot;&gt;module &lt;/span&gt;&lt;span class=&quot;module&quot;&gt;RMagickTextUtil&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;def &lt;/span&gt;&lt;span class=&quot;method&quot;&gt;render_cropped_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;percent&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;to_f&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;to_f&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;percent&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;to_i&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# takes a leap into cropping&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# reduce in big chunks until within range&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# lengthen in smaller steps until exceed&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# reduce in baby steps until fit&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;def &lt;/span&gt;&lt;span class=&quot;method&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;constant&quot;&gt;Magick&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;constant&quot;&gt;Image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;caption:&lt;span class=&quot;expr&quot;&gt;#{caption_text.to_s}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;)&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;{&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;comment&quot;&gt;# this wraps the text to fixed width&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;constant&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;comment&quot;&gt;# other optional settings&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;constant&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;block_given?&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;punct&quot;&gt;}.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;first&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;p&gt;Update: fixes infinite loop when empty string cannot satisfy height and width constraint&lt;/p&gt;" />
<meta property="og:description" content="Been using RMagick at work, and was required to do something that wasn&#39;t supported directly: Rendering a chunk of lengthy text into a fixed size image, with a selected font color. Quite strange actually, because as far as rendering text goes, I would&#39;ve thought that&#39;s a common use case. 1. Selected font color RMagick provides 2 ways of rendering text: Using the caption builtin format or Draw#annotate. Annotate loses since it doesn&#39;t do word-wrap, but caption does. So... DIY word-wrapping with annotate? Ugh. The kick is, I could get &quot;annotate&quot; to set the font color, I couldn&#39;t make &quot;caption&quot; do the same though the documentation says it can. Tip #26 from the very valuable Pragmatic Programmer book is &lt;blockquote&gt; &lt;p&gt;&amp;quot;select&amp;quot;&amp;nbsp; Isn&#39;t Broken&lt;br /&gt; It is rare to find a bug in the OS or the compiler, or even a third-party product or library. The bug is most likely in the application.&lt;/p&gt; &lt;/blockquote&gt; &lt;p&gt;This refers to programmers jumping to conclusion that some strange bug is caused by bugs in the lower-level library / operating system just because he cannot figure how his own code would be faulty. When you can&#39;t find the bug in your code, operating under &amp;quot;select is not broken&amp;quot; mode means that you &amp;quot;look again&amp;quot; in your own code, turn it over, around and shake out the loose bits - you&#39;ll usually find its actually your own fault.&lt;/p&gt; &lt;p&gt;Operating under this mode has a few benefits. First, your colleagues will stop avoiding you. Secondly, you&#39;ll learn a hell lot about your own code, debugging and the underlying library you are using.&amp;nbsp;However, when you&#39;ve tried different ways, with the simplest possible piece of code (out of the context of your application) and it still doesn&#39;t work, it wouldn&#39;t hurt to question.&lt;br /&gt; &lt;br /&gt; Lucky me, the proverbial &amp;quot;&lt;a href=&quot;http://en.wikipedia.org/wiki/Asynchronous_I/O#Select.28.2Fpoll.29_loop&quot;&gt;select&lt;/a&gt;&amp;quot; was indeed broken and Tim Hunter was blazing fast in his response. RMagick::Image::Info.fill= wasn&#39;t working in &amp;quot;caption&amp;quot; mode, but now it does. My rendered, word-wrapped text now has colors.&lt;/p&gt; &lt;p&gt;2. Rendering into a fixed size&lt;/p&gt; &lt;p&gt;Word wrap allows me to constrain my text into a specific width, however it doesn&#39;t trim my text properly height-wise. If the image height is shorter than the rendered result, text gets clipped mercilessly - sometimes halfway across the font, depending on your image height and font size. I didn&#39;t find any option for such trimming, neither could I google an off the shelf solution. So I wrote my own. And since I felt that this &amp;quot;rendering a chunk of lengthy text into a fixed size image, with a selected font color&amp;quot; thingy is a rather common use case, I guess I might as well put the code out. Feel free to contribute any suggestion to speed up the trimming:&lt;/p&gt;&lt;pre&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# Generate Magick::Image objects from text&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# * wraps text around width_constraint (pixels)&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# * cuts off text (and appends &#39;...&#39;) if it goes beyond height_constraint (pixels)&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# Example&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;lt;code&amp;gt;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# require &#39;rmagick_text_util.rb&#39;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# include RMagickTextUtil&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# some_text = &amp;quot;Hello world. This is a rather lengthy line &amp;quot; +&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;quot;and I&#39;m not very sure how much will be cropped, &amp;quot; +&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;quot;and how much will be left over. So, here goes!&amp;quot;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image = render_cropped_text(some_text, 100, 50)&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image.write &amp;quot;example_without_block.jpg&amp;quot;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image = render_cropped_text(some_text, 100, 50) do |img|&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# img.fill = &amp;quot;#ff0000&amp;quot; # this won&#39;t work until RMagick v1.15.3&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# img.pointsize = 15&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# end&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image.write &amp;quot;example_with_block.jpg&amp;quot;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;lt;/code&amp;gt;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;ident&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;RMagick&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&#39;&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;span class=&quot;keyword&quot;&gt;module &lt;/span&gt;&lt;span class=&quot;module&quot;&gt;RMagickTextUtil&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;def &lt;/span&gt;&lt;span class=&quot;method&quot;&gt;render_cropped_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;percent&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;to_f&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;to_f&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;percent&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;to_i&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# takes a leap into cropping&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# reduce in big chunks until within range&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# lengthen in smaller steps until exceed&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# reduce in baby steps until fit&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;def &lt;/span&gt;&lt;span class=&quot;method&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;constant&quot;&gt;Magick&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;constant&quot;&gt;Image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;caption:&lt;span class=&quot;expr&quot;&gt;#{caption_text.to_s}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;)&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;{&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;comment&quot;&gt;# this wraps the text to fixed width&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;constant&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;comment&quot;&gt;# other optional settings&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;constant&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;block_given?&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;punct&quot;&gt;}.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;first&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;p&gt;Update: fixes infinite loop when empty string cannot satisfy height and width constraint&lt;/p&gt;" />
<link rel="canonical" href="http://localhost:4000/weblog/2007/02/rmagick-renderi.html" />
<meta property="og:url" content="http://localhost:4000/weblog/2007/02/rmagick-renderi.html" />
<meta property="og:site_name" content="The Devel!" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2007-02-21T00:00:00+08:00" />
<script type="application/ld+json">
{"headline":"RMagick: Rendering a chunk of lengthy text into a fixed size image, with a selected font color","dateModified":"2007-02-21T00:00:00+08:00","datePublished":"2007-02-21T00:00:00+08:00","author":{"@type":"Person","name":"choonkeat"},"description":"Been using RMagick at work, and was required to do something that wasn&#39;t supported directly: Rendering a chunk of lengthy text into a fixed size image, with a selected font color. Quite strange actually, because as far as rendering text goes, I would&#39;ve thought that&#39;s a common use case. 1. Selected font color RMagick provides 2 ways of rendering text: Using the caption builtin format or Draw#annotate. Annotate loses since it doesn&#39;t do word-wrap, but caption does. So... DIY word-wrapping with annotate? Ugh. The kick is, I could get &quot;annotate&quot; to set the font color, I couldn&#39;t make &quot;caption&quot; do the same though the documentation says it can. Tip #26 from the very valuable Pragmatic Programmer book is &lt;blockquote&gt; &lt;p&gt;&amp;quot;select&amp;quot;&amp;nbsp; Isn&#39;t Broken&lt;br /&gt; It is rare to find a bug in the OS or the compiler, or even a third-party product or library. The bug is most likely in the application.&lt;/p&gt; &lt;/blockquote&gt; &lt;p&gt;This refers to programmers jumping to conclusion that some strange bug is caused by bugs in the lower-level library / operating system just because he cannot figure how his own code would be faulty. When you can&#39;t find the bug in your code, operating under &amp;quot;select is not broken&amp;quot; mode means that you &amp;quot;look again&amp;quot; in your own code, turn it over, around and shake out the loose bits - you&#39;ll usually find its actually your own fault.&lt;/p&gt; &lt;p&gt;Operating under this mode has a few benefits. First, your colleagues will stop avoiding you. Secondly, you&#39;ll learn a hell lot about your own code, debugging and the underlying library you are using.&amp;nbsp;However, when you&#39;ve tried different ways, with the simplest possible piece of code (out of the context of your application) and it still doesn&#39;t work, it wouldn&#39;t hurt to question.&lt;br /&gt; &lt;br /&gt; Lucky me, the proverbial &amp;quot;&lt;a href=&quot;http://en.wikipedia.org/wiki/Asynchronous_I/O#Select.28.2Fpoll.29_loop&quot;&gt;select&lt;/a&gt;&amp;quot; was indeed broken and Tim Hunter was blazing fast in his response. RMagick::Image::Info.fill= wasn&#39;t working in &amp;quot;caption&amp;quot; mode, but now it does. My rendered, word-wrapped text now has colors.&lt;/p&gt; &lt;p&gt;2. Rendering into a fixed size&lt;/p&gt; &lt;p&gt;Word wrap allows me to constrain my text into a specific width, however it doesn&#39;t trim my text properly height-wise. If the image height is shorter than the rendered result, text gets clipped mercilessly - sometimes halfway across the font, depending on your image height and font size. I didn&#39;t find any option for such trimming, neither could I google an off the shelf solution. So I wrote my own. And since I felt that this &amp;quot;rendering a chunk of lengthy text into a fixed size image, with a selected font color&amp;quot; thingy is a rather common use case, I guess I might as well put the code out. Feel free to contribute any suggestion to speed up the trimming:&lt;/p&gt;&lt;pre&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# Generate Magick::Image objects from text&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# * wraps text around width_constraint (pixels)&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# * cuts off text (and appends &#39;...&#39;) if it goes beyond height_constraint (pixels)&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# Example&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;lt;code&amp;gt;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# require &#39;rmagick_text_util.rb&#39;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# include RMagickTextUtil&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# some_text = &amp;quot;Hello world. This is a rather lengthy line &amp;quot; +&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;quot;and I&#39;m not very sure how much will be cropped, &amp;quot; +&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;quot;and how much will be left over. So, here goes!&amp;quot;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image = render_cropped_text(some_text, 100, 50)&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image.write &amp;quot;example_without_block.jpg&amp;quot;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image = render_cropped_text(some_text, 100, 50) do |img|&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# img.fill = &amp;quot;#ff0000&amp;quot; # this won&#39;t work until RMagick v1.15.3&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# img.pointsize = 15&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# end&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# image.write &amp;quot;example_with_block.jpg&amp;quot;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;# &amp;lt;/code&amp;gt;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;ident&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&#39;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;RMagick&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&#39;&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;span class=&quot;keyword&quot;&gt;module &lt;/span&gt;&lt;span class=&quot;module&quot;&gt;RMagickTextUtil&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;def &lt;/span&gt;&lt;span class=&quot;method&quot;&gt;render_cropped_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;percent&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;to_f&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;to_f&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;percent&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;to_i&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# takes a leap into cropping&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# reduce in big chunks until within range&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;80&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# lengthen in smaller steps until exceed&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;height_constraint&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;# reduce in baby steps until fit&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;-=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;end_index&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;image&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;def &lt;/span&gt;&lt;span class=&quot;method&quot;&gt;render_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;caption_text&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;constant&quot;&gt;Magick&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;constant&quot;&gt;Image&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&amp;quot;&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;caption:&lt;span class=&quot;expr&quot;&gt;#{caption_text.to_s}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;&amp;quot;)&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;{&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;comment&quot;&gt;# this wraps the text to fixed width&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;constant&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;size&lt;/span&gt; &lt;span class=&quot;punct&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;width_constraint&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;comment&quot;&gt;# other optional settings&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;ident&quot;&gt;block&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;constant&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;punct&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;ident&quot;&gt;block_given?&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;punct&quot;&gt;}.&lt;/span&gt;&lt;span class=&quot;ident&quot;&gt;first&lt;/span&gt;&lt;br /&gt; &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/pre&gt;&lt;p&gt;Update: fixes infinite loop when empty string cannot satisfy height and width constraint&lt;/p&gt;","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/weblog/2007/02/rmagick-renderi.html"},"url":"http://localhost:4000/weblog/2007/02/rmagick-renderi.html","@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="The Devel!" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">The Devel!</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">RMagick: Rendering a chunk of lengthy text into a fixed size image, with a selected font color</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2007-02-21T00:00:00+08:00" itemprop="datePublished">Feb 21, 2007
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Been using RMagick at work, and was required to do something that wasn't supported directly: Rendering a chunk of lengthy text into a fixed size image, with a selected font color. Quite strange actually, because as far as rendering text goes, I would've thought that's a common use case.<br />  </p>   <p>1. Selected font color</p>   <p>RMagick provides 2 ways of rendering text: Using the <a href="http://www.simplesystems.org/RMagick/doc/imusage.html#bi_format_list">caption builtin format</a> or <a href="http://www.simplesystems.org/RMagick/doc/draw.html#annotate">Draw#annotate</a>. Annotate loses since it doesn't do word-wrap, but caption does. So... DIY word-wrapping with annotate? Ugh. The kick is, I could get &quot;annotate&quot; to set the font color, I couldn't make &quot;caption&quot; do the same though the documentation says it can.<br />  </p>   <p>Tip #26 from the very valuable <a href="http://www.pragmaticprogrammer.com/ppbook/extracts/rule_list.html">Pragmatic Programmer</a> book is <br />   </p>      <blockquote>     <p>&quot;select&quot;&nbsp; Isn't Broken<br />   It is rare to find a bug in the OS or the compiler, or even a third-party product or library. The bug is most likely in the application.</p>   </blockquote>      <p>This refers to programmers jumping to conclusion that some strange bug is caused by bugs in the lower-level library / operating system just because he cannot figure how his own code would be faulty. When you can't find the bug in your code, operating under &quot;select is not broken&quot; mode means that you &quot;look again&quot; in your own code, turn it over, around and shake out the loose bits - you'll usually find its actually your own fault.</p>     <p>Operating under this mode has a few benefits. First, your colleagues will stop avoiding you. Secondly, you'll learn a hell lot about your own code, debugging and the underlying library you are using.&nbsp;However, when you've tried different ways, with the simplest possible piece of code (out of the context of your application) and it still doesn't work, it wouldn't hurt to question.<br />   <br />   Lucky me, the proverbial &quot;<a href="http://en.wikipedia.org/wiki/Asynchronous_I/O#Select.28.2Fpoll.29_loop">select</a>&quot; was indeed broken and Tim Hunter was blazing fast in his response. RMagick::Image::Info.fill= wasn't working in &quot;caption&quot; mode, but now it does. My rendered, word-wrapped text now has colors.</p>   <p>2. Rendering into a fixed size</p>   <p>Word wrap allows me to constrain my text into a specific width, however it doesn't trim my text properly height-wise. If the image height is shorter than the rendered result, text gets clipped mercilessly - sometimes halfway across the font, depending on your image height and font size. I didn't find any option for such trimming, neither could I google an off the shelf solution. So I wrote my own. And since I felt that this &quot;rendering a chunk of lengthy text into a fixed size image, with a selected font color&quot; thingy is a rather common use case, I guess I might as well put the code out. Feel free to contribute any suggestion to speed up the trimming:</p><pre><span class="comment">#</span><br /><span class="comment"># Generate Magick::Image objects from text</span><br /><span class="comment">#  * wraps text around width_constraint (pixels)</span><br /><span class="comment">#  * cuts off text (and appends '...') if it goes beyond height_constraint (pixels)</span><br /><span class="comment">#</span><br /><span class="comment"># Example</span><br /><span class="comment"># &lt;code&gt;</span><br /><span class="comment">#    require 'rmagick_text_util.rb'</span><br /><span class="comment">#    include RMagickTextUtil</span><br /><span class="comment">#    some_text = &quot;Hello world. This is a rather lengthy line &quot;      +</span><br /><span class="comment">#                &quot;and I'm not very sure how much will be cropped, &quot; +</span><br /><span class="comment">#                &quot;and how much will be left over. So, here goes!&quot;</span><br /><span class="comment">#</span><br /><span class="comment">#    image = render_cropped_text(some_text, 100, 50)</span><br /><span class="comment">#    image.write &quot;example_without_block.jpg&quot;</span><br /><span class="comment">#</span><br /><span class="comment">#    image = render_cropped_text(some_text, 100, 50) do |img|</span><br /><span class="comment">#       img.fill = &quot;#ff0000&quot; # this won't work until RMagick v1.15.3</span><br /><span class="comment">#       img.pointsize = 15</span><br /><span class="comment">#    end</span><br /><span class="comment">#    image.write &quot;example_with_block.jpg&quot;</span><br /><span class="comment"># &lt;/code&gt;</span><br /><span class="comment">#</span><br /><span class="ident">require</span> <span class="punct">'</span><span class="string">RMagick</span><span class="punct">'</span><br /><br /><span class="keyword">module </span><span class="module">RMagickTextUtil</span><br />    <span class="keyword">def </span><span class="method">render_cropped_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="ident">height_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />        <span class="ident">image</span> <span class="punct">=</span> <span class="ident">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />        <span class="keyword">if</span> <span class="ident">height_constraint</span> <span class="punct">&lt;</span> <span class="ident">image</span><span class="punct">.</span><span class="ident">rows</span><br />            <span class="ident">percent</span> <span class="punct">=</span> <span class="ident">height_constraint</span><span class="punct">.</span><span class="ident">to_f</span> <span class="punct">/</span> <span class="ident">image</span><span class="punct">.</span><span class="ident">rows</span><span class="punct">.</span><span class="ident">to_f</span><br />            <span class="ident">end_index</span> <span class="punct">=</span> <span class="punct">(</span><span class="ident">caption_text</span><span class="punct">.</span><span class="ident">size</span> <span class="punct">*</span> <span class="ident">percent</span><span class="punct">).</span><span class="ident">to_i</span>  <span class="comment"># takes a leap into cropping</span><br />            <span class="ident">image</span> <span class="punct">=</span> <span class="ident">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="ident">end_index</span><span class="punct">]</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string">...</span><span class="punct">&quot;,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />            <span class="keyword">while</span> <span class="ident">height_constraint</span> <span class="punct">&lt;</span> <span class="ident">image</span><span class="punct">.</span><span class="ident">rows</span> <span class="punct">&amp;&amp;</span> <span class="ident">end_index</span> <span class="punct">&gt;</span> <span class="number">0</span> <span class="comment"># reduce in big chunks until within range</span><br />                <span class="ident">end_index</span> <span class="punct">-=</span> <span class="number">80</span><br />                <span class="ident">image</span> <span class="punct">=</span> <span class="ident">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="ident">end_index</span><span class="punct">]</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string">...</span><span class="punct">&quot;,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />            <span class="keyword">end</span><br />            <span class="keyword">while</span> <span class="ident">height_constraint</span> <span class="punct">&gt;</span> <span class="ident">image</span><span class="punct">.</span><span class="ident">rows</span>                  <span class="comment"># lengthen in smaller steps until exceed</span><br />                <span class="ident">end_index</span> <span class="punct">+=</span> <span class="number">10</span><br />                <span class="ident">image</span> <span class="punct">=</span> <span class="ident">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="ident">end_index</span><span class="punct">]</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string">...</span><span class="punct">&quot;,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />            <span class="keyword">end</span><br />            <span class="keyword">while</span> <span class="ident">height_constraint</span> <span class="punct">&lt;</span> <span class="ident">image</span><span class="punct">.</span><span class="ident">rows</span> <span class="punct">&amp;&amp;</span> <span class="ident">end_index</span> <span class="punct">&gt;</span> <span class="number">0</span> <span class="comment"># reduce in baby steps until fit</span><br />                <span class="ident">end_index</span> <span class="punct">-=</span> <span class="number">1</span><br />                <span class="ident">image</span> <span class="punct">=</span> <span class="ident">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">[</span><span class="number">0</span><span class="punct">..</span><span class="ident">end_index</span><span class="punct">]</span> <span class="punct">+</span> <span class="punct">&quot;</span><span class="string">...</span><span class="punct">&quot;,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />            <span class="keyword">end</span><br />        <span class="keyword">end</span><br />        <span class="ident">image</span><br />    <span class="keyword">end</span><br /><br />    <span class="keyword">def </span><span class="method">render_text</span><span class="punct">(</span><span class="ident">caption_text</span><span class="punct">,</span> <span class="ident">width_constraint</span><span class="punct">,</span> <span class="punct">&amp;</span><span class="ident">block</span><span class="punct">)</span><br />        <span class="constant">Magick</span><span class="punct">::</span><span class="constant">Image</span><span class="punct">.</span><span class="ident">read</span><span class="punct">(&quot;</span><span class="string">caption:<span class="expr">#{caption_text.to_s}</span></span><span class="punct">&quot;)</span> <span class="punct">{</span><br />            <span class="comment"># this wraps the text to fixed width</span><br />            <span class="constant">self</span><span class="punct">.</span><span class="ident">size</span> <span class="punct">=</span> <span class="ident">width_constraint</span><br />            <span class="comment"># other optional settings</span><br />            <span class="ident">block</span><span class="punct">.</span><span class="ident">call</span><span class="punct">(</span><span class="constant">self</span><span class="punct">)</span> <span class="keyword">if</span> <span class="ident">block_given?</span><br />        <span class="punct">}.</span><span class="ident">first</span><br />    <span class="keyword">end</span><br /><span class="keyword">end</span></pre><p>Update: fixes infinite loop when empty string cannot satisfy height and width constraint</p>


  </div><a class="u-url" href="/weblog/2007/02/rmagick-renderi.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">The Devel!</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">choonkeat</li><li><a class="u-email" href="mailto:contactme@choonkeat.com">contactme@choonkeat.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/choonkeat"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">choonkeat</span></a></li><li><a href="https://www.twitter.com/choonkeat"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">choonkeat</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>choonkeat on programming &amp; software</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
